# Bug ä¿®å¤åˆ†æç¤ºä¾‹ï¼šå¹¶å‘è¿æ¥é—®é¢˜

> è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Bug åˆ†æç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨æ¨¡æ¿

---

## 1. é—®é¢˜æ¦‚è¿°
é«˜å¹¶å‘åœºæ™¯ä¸‹å¤šæ¬¡è°ƒç”¨ `connect()` ä¼šåˆ›å»ºå¤šä¸ªæ•°æ®åº“è¿æ¥

## 2. æ ¹æœ¬åŸå› åˆ†æ

### ä¸ºä»€ä¹ˆä¼šæœ‰é—®é¢˜ï¼Ÿ

**æŠ€æœ¯åŸå› **ï¼šCheck-Then-Act ç«æ€æ¡ä»¶

```javascript
// âŒ åŸå§‹ä»£ç 
async connect() {
    // æ­¥éª¤1: æ£€æŸ¥æ˜¯å¦å·²è¿æ¥
    if (this.dbInstance) {
        return this.dbInstance;
    }
    
    // æ­¥éª¤2: å»ºç«‹è¿æ¥ï¼ˆå¼‚æ­¥æ“ä½œï¼‰
    const result = await ConnectionManager.connect(...);
    
    // æ­¥éª¤3: ä¿å­˜è¿æ¥
    this.dbInstance = result;
    return this.dbInstance;
}
```

**é—®é¢˜æœºåˆ¶**ï¼š

1. **ç«æ€çª—å£**ï¼šæ­¥éª¤1å’Œæ­¥éª¤3ä¹‹é—´å­˜åœ¨æ—¶é—´çª—å£
2. **å¹¶å‘æ‰§è¡Œ**ï¼š
   - æ—¶åˆ» T1ï¼šè¯·æ±‚A æ£€æŸ¥ `this.dbInstance` ä¸º null â†’ é€šè¿‡
   - æ—¶åˆ» T1ï¼šè¯·æ±‚B æ£€æŸ¥ `this.dbInstance` ä¸º null â†’ é€šè¿‡
   - æ—¶åˆ» T2ï¼šè¯·æ±‚A å¼€å§‹è¿æ¥ï¼ˆawait è®©å‡ºæ§åˆ¶æƒï¼‰
   - æ—¶åˆ» T2ï¼šè¯·æ±‚B å¼€å§‹è¿æ¥ï¼ˆä¹Ÿåœ¨è¿æ¥ï¼‰
   - ç»“æœï¼šåˆ›å»ºäº†ä¸¤ä¸ªè¿æ¥

**æ ¹æœ¬åŸå› **ï¼š
- JavaScript å¼‚æ­¥ç‰¹æ€§ï¼š`await` ä¼šè®©å‡ºæ‰§è¡Œæƒ
- ç¼ºå°‘åŒæ­¥æœºåˆ¶ï¼šæ²¡æœ‰äº’æ–¥é”ä¿æŠ¤ä¸´ç•ŒåŒº
- æ£€æŸ¥å’Œæ“ä½œéåŸå­ï¼šif åˆ¤æ–­å’Œè¿æ¥æ“ä½œä¹‹é—´ä¸æ˜¯åŸå­çš„

## 3. å½±å“å¯¹æ¯”

| ç»´åº¦ | ä¸ä¿®å¤çš„åæœ | ä¿®å¤åçš„æ•ˆæœ |
|------|-------------|-------------|
| **åŠŸèƒ½** | åˆ›å»ºå¤šä¸ªè¿æ¥ï¼Œè¿”å›çš„è¿æ¥å¯¹è±¡ä¸ä¸€è‡´ | æ‰€æœ‰è¯·æ±‚å…±äº«åŒä¸€ä¸ªè¿æ¥ |
| **æ€§èƒ½** | æ¯ä¸ªè¿æ¥å ç”¨ ~10MB å†…å­˜ï¼Œ10å¹¶å‘ = 100MB | ä»…ä¸€ä¸ªè¿æ¥ï¼Œ10MB å†…å­˜ |
| **ç¨³å®šæ€§** | MongoDB è¿æ¥æ± è€—å°½ï¼Œæ–°è¯·æ±‚è¢«æ‹’ç» | è¿æ¥å¤ç”¨ï¼Œç¨³å®šå¯é  |
| **èµ„æº** | æ•°æ®åº“æœåŠ¡å™¨å‹åŠ›å¤§ï¼Œè¿æ¥æ•°è¿‡å¤š | èµ„æºä½¿ç”¨ä¼˜åŒ– |

**è§¦å‘æ¡ä»¶**ï¼š
- âœ… å¿…ç°ï¼š10ä¸ªå¹¶å‘è¯·æ±‚åŒæ—¶è°ƒç”¨ `connect()`
- âœ… é«˜å¹¶å‘åœºæ™¯ï¼ˆæµé‡é«˜å³°ã€è´Ÿè½½æµ‹è¯•ï¼‰
- âœ… å†·å¯åŠ¨æ—¶ï¼ˆå¤šä¸ªæ¨¡å—åŒæ—¶åˆå§‹åŒ–ï¼‰

**å®é™…å½±å“**ï¼š
```javascript
// æµ‹è¯•ï¼š10å¹¶å‘è¯·æ±‚
const promises = Array(10).fill(null).map(() => msq.connect());
const results = await Promise.all(promises);

// âŒ ä¿®å¤å‰ï¼šresults[0] !== results[1] !== results[2] ...
//    åˆ›å»ºäº† 10 ä¸ªä¸åŒçš„è¿æ¥

// âœ… ä¿®å¤åï¼šresults[0] === results[1] === results[2] ...
//    æ‰€æœ‰è¯·æ±‚å…±äº«åŒä¸€ä¸ªè¿æ¥
```

## 4. ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ˜¯å¦é‡‡ç”¨ | åŸå›  |
|------|------|------|---------|------|
| **æ–¹æ¡ˆA: ä½¿ç”¨ Promise é”** | ç®€å•ï¼Œæ— éœ€é¢å¤–ä¾èµ– | éœ€è¦æ‰‹åŠ¨ç®¡ç†é”çŠ¶æ€ | âœ… | æœ€é€‚åˆå¼‚æ­¥åœºæ™¯ |
| æ–¹æ¡ˆB: ä½¿ç”¨äº’æ–¥é”åº“ï¼ˆasync-mutexï¼‰ | åŠŸèƒ½å®Œæ•´ï¼Œä¹…ç»è€ƒéªŒ | å¢åŠ å¤–éƒ¨ä¾èµ– | âŒ | è¿‡åº¦è®¾è®¡ |
| æ–¹æ¡ˆC: ä½¿ç”¨æ ‡å¿—ä½ + è½®è¯¢ | å®ç°ç®€å• | æµªè´¹ CPUï¼Œä¸ä¼˜é›… | âŒ | æ€§èƒ½å·® |

### å®æ–½ç»†èŠ‚

**æ–‡ä»¶ä¿®æ”¹**ï¼š
- `lib/index.js`ï¼šæ·»åŠ ä¸Šå±‚è¿æ¥é”
- `lib/mongodb/index.js`ï¼šæ·»åŠ  MongoDB é€‚é…å™¨å±‚è¿æ¥é”

**æ ¸å¿ƒæ”¹åŠ¨**ï¼š

```javascript
// âœ… ä¿®å¤å
async connect() {
    // å¿«é€Ÿè·¯å¾„ï¼šå·²è¿æ¥ç›´æ¥è¿”å›
    if (this.dbInstance) {
        return this.dbInstance;
    }
    
    // ğŸ”’ å…³é”®ä¿®å¤ï¼šä½¿ç”¨ Promise ä½œä¸ºé”
    if (this._connecting) {
        return this._connecting;  // ç­‰å¾…é¦–ä¸ªè¿æ¥å®Œæˆ
    }
    
    try {
        // åˆ›å»ºè¿æ¥ Promise å¹¶ä¿å­˜ä¸ºé”
        this._connecting = (async () => {
            const result = await ConnectionManager.connect(...);
            this.dbInstance = result;
            return this.dbInstance;
        })();
        
        // ç­‰å¾…è¿æ¥å®Œæˆ
        const result = await this._connecting;
        this._connecting = null;  // æ¸…ç†é”
        return result;
    } catch (err) {
        this._connecting = null;  // å¤±è´¥ä¹Ÿè¦æ¸…ç†é”
        throw err;
    }
}
```

**ä¸ºä»€ä¹ˆè¿™æ ·ä¿®å¤ï¼Ÿ**

1. **Promise ä½œä¸ºé”**ï¼š
   - ä¼˜åŠ¿ï¼šåŸç”Ÿæ”¯æŒï¼Œæ— éœ€å¤–éƒ¨åº“
   - æœºåˆ¶ï¼šç¬¬ä¸€ä¸ªè¯·æ±‚åˆ›å»º Promiseï¼Œåç»­è¯·æ±‚ç­‰å¾…åŒä¸€ä¸ª Promise

2. **åŒé‡æ£€æŸ¥**ï¼š
   - ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼š`if (this.dbInstance)` - å¿«é€Ÿè·¯å¾„
   - ç¬¬äºŒæ¬¡æ£€æŸ¥ï¼š`if (this._connecting)` - è¿æ¥ä¸­ç­‰å¾…

3. **å¼‚å¸¸å®‰å…¨**ï¼š
   - try-catch ç¡®ä¿å¤±è´¥æ—¶æ¸…ç†é”
   - é¿å…é”æ°¸ä¹…æŒæœ‰å¯¼è‡´æ­»é”

### é£é™©è¯„ä¼°
- âŒ æ— ç ´åæ€§å˜æ›´ï¼ˆå‘åå…¼å®¹ï¼‰
- âŒ ä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼ˆä»…ä¿®å¤å¹¶å‘é—®é¢˜ï¼‰
- âŒ æ— éœ€æ•°æ®è¿ç§»

## 5. éªŒè¯æ–¹æ³•

**å•å…ƒæµ‹è¯•**ï¼š
```javascript
it('å¹¶å‘è°ƒç”¨ connect() åº”è¯¥åªå»ºç«‹ä¸€ä¸ªè¿æ¥', async function() {
    const msq = new MonSQLize({ ... });
    
    // æ¨¡æ‹Ÿ 10 ä¸ªå¹¶å‘è¯·æ±‚
    const promises = Array(10).fill(null).map(() => msq.connect());
    const results = await Promise.all(promises);
    
    // éªŒè¯æ‰€æœ‰è¿”å›åŒä¸€å¯¹è±¡
    const firstConn = results[0];
    for (let i = 1; i < results.length; i++) {
        assert.strictEqual(results[i], firstConn);
    }
});
```

**æ€§èƒ½å¯¹æ¯”**ï¼š
```javascript
// ä¿®å¤å‰ï¼šå†…å­˜å ç”¨ ~100MBï¼ˆ10ä¸ªè¿æ¥ï¼‰
// ä¿®å¤åï¼šå†…å­˜å ç”¨ ~10MBï¼ˆ1ä¸ªè¿æ¥ï¼‰
// æ”¹å–„ï¼š90% å†…å­˜èŠ‚çœ
```

## 6. ç»éªŒæ•™è®­

**ç¼–ç è§„èŒƒ**ï¼š
- âœ… å¼‚æ­¥æ–¹æ³•ä¸­çš„å…±äº«çŠ¶æ€éœ€è¦åŒæ­¥ä¿æŠ¤
- âœ… Check-Then-Act æ¨¡å¼è¦ç”¨åŸå­æ“ä½œæˆ–é”
- âœ… å•ä¾‹æ¨¡å¼å¿…é¡»è€ƒè™‘å¹¶å‘åœºæ™¯

**å®¡æŸ¥é‡ç‚¹**ï¼š
- ğŸ” æŸ¥æ‰¾æ‰€æœ‰ `if (this.xxx)` + `await` çš„ç»„åˆ
- ğŸ” å•ä¾‹/è¿æ¥æ± ç­‰å…±äº«èµ„æºçš„åˆå§‹åŒ–é€»è¾‘
- ğŸ” é«˜å¹¶å‘åœºæ™¯çš„ç«æ€æ¡ä»¶

**æœ€ä½³å®è·µ**ï¼š
```javascript
// âœ… æ¨èï¼šä½¿ç”¨ Promise é”æ¨¡å¼
async initialize() {
    if (this.initialized) return;
    if (this._initializing) return this._initializing;
    
    this._initializing = (async () => {
        await doExpensiveWork();
        this.initialized = true;
    })();
    
    await this._initializing;
    this._initializing = null;
}

// âŒ é¿å…ï¼šç®€å• if æ£€æŸ¥ + async æ“ä½œ
async initialize() {
    if (this.initialized) return;
    await doExpensiveWork();  // âš ï¸ ç«æ€æ¡ä»¶
    this.initialized = true;
}
```
