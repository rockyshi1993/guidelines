# 规范遵守改进总结

## 📋 问题根源分析

### 为什么 AI 不遵守项目规范？

**核心问题**：AI 的**通用知识库**（预训练数据）与**项目特定规范**冲突时，AI **优先使用了通用最佳实践**。

| 通用最佳实践（AI 默认行为） | chat 项目规范 | AI 的错误选择 |
|--------------------------|---------------|------------|
| ✅ 使用 Service 层分离关注点 | 🔴 **禁止 Service 层** | ❌ AI 用了 Service |
| ✅ 使用 DTO + class-validator | 🔴 **强制使用 Joi** | ❌ AI 用了 DTO |
| ✅ 使用 Jest 测试框架 | 🔴 **强制使用 Mocha** | ❌ AI 用了 Jest |

### 为什么会优先通用实践？

1. **指令优先级混淆**：
   - 项目规范在 `copilot-instructions.md` 中**作为参考文档引用**
   - 但 AI 的内置知识说"Service 层是好实践"
   - AI 错误地认为"好实践 > 项目规范"

2. **规范表达不够强制**：
   - `profiles/chat.md` 中**显示了 `app/service/` 目录**
   - 但**没有明确写"禁止使用 Service 层"**
   - AI 看到目录结构就认为"允许使用"

3. **缺少明确的检查清单**：
   - `copilot-instructions.md` 的检查清单中**没有"禁止 Service 层"这一条**
   - AI 执行检查时**没有触发警告**

---

## ✅ 解决方案实施

### 1. 修改通用规范 (`copilot-instructions.md`)

#### 1.1 强化决策流程（添加"场景 0"）

```yaml
[0] 🔴 【强制第一步】读取项目 Profile
[0.1] 🔴 识别项目特定禁止项（Service层/DTO/测试框架等）
[0.2] 🔴 项目规范 > 通用最佳实践（强制覆盖）
```

#### 1.2 新增"场景 0：项目规范强制检查"

所有代码实现任务前必须执行：
- ✅ 识别项目名称
- ✅ 读取项目 Profile（完整通读）
- ✅ 提取强制规范（禁止项、技术栈要求、编码规范）
- ✅ 冲突检查（项目规范 vs 通用实践）
- ✅ 自我确认（5个核心问题）

#### 1.3 新增"阶段 0：项目规范确认"检查清单

```yaml
[ ] 🔴 读取项目 Profile（完整通读）
[ ] 🔴 提取架构禁止项（Service/Repository/DTO）
[ ] 🔴 提取技术栈要求（Joi/Mocha/utilsCrud）
[ ] 🔴 提取编码规范（中文注释/kebab-case）
[ ] 🔴 冲突检查（项目规范 vs 通用实践）
[ ] 🔴 自我确认（我是否会使用禁止技术？必须 NO）
```

#### 1.4 新增"项目规范违规"禁止项（最高优先级）

```yaml
🔴 项目规范违规（最严重）:
- ❌ 未读取项目 Profile 就开始写代码
- ❌ 使用项目明确禁止的技术
- ❌ 使用项目未指定的验证库
- ❌ 使用项目未指定的测试框架
- ❌ 忽略项目规范，自作主张"优化"架构
- ❌ 认为"通用最佳实践"比"项目规范"更重要
```

---

### 2. 修改项目规范 (`profiles/chat.md`)

#### 2.1 新增"架构与技术栈强制规范"章节

明确 5 个核心强制规范：

##### 🔴 架构层次禁止项
- **禁止 Service 层**：不创建 `app/service/`，Controller 直接操作数据库
- **目录结构调整**：删除 `app/service/` 说明，标注为历史遗留

##### 🔴 参数验证强制规范
- **强制使用 Joi**：使用 `ctx.Joi` + `ctx.validateJoi()`
- **禁止 class-validator**：禁止定义 DTO 类

##### 🔴 测试框架强制规范
- **强制使用 Mocha + Chai**：使用 `mocha` + `chai` + `egg-mock`
- **禁止 Jest**：禁止使用 `@jest/globals`

##### 🔴 数据库操作强制规范
- **强制使用 utilsCrud**：使用 `ctx.utilsCrud.findOne()` 等方法
- **谨慎使用 Mongoose API**：仅特殊场景

##### 🔴 注释语言强制规范
- **强制中文注释**：Model 字段、函数、复杂逻辑
- **技术术语保留英文**：JWT、OAuth、CRUD

#### 2.2 每个规范都提供"正确做法"和"错误示例"

```typescript
// ✅ 正确 - Controller 直接操作数据库
export default class NotificationSettingsController extends Controller {
    public async getSettings() {
        const { ctx } = this;
        const { utilsCrud } = ctx as any;
        const settings = await utilsCrud.findOne(...);
        return ctx.success(settings);
    }
}

// ❌ 错误 - 不要创建 Service 层
// app/service/notification-settings.service.ts  ← 禁止！
```

---

## 📊 修改对比

### 修改前

| 文件 | 问题 |
|------|------|
| `copilot-instructions.md` | ❌ 没有"项目规范优先"的明确声明 |
| `copilot-instructions.md` | ❌ 检查清单中没有"项目规范确认"步骤 |
| `copilot-instructions.md` | ❌ 场景触发器没有"读取 Profile"前置步骤 |
| `profiles/chat.md` | ❌ 目录结构显示 `app/service/`，误导 AI |
| `profiles/chat.md` | ❌ 没有明确写"禁止 Service 层" |
| `profiles/chat.md` | ❌ 没有明确写"强制 Joi" |
| `profiles/chat.md` | ❌ 没有明确写"强制 Mocha" |

### 修改后

| 文件 | 改进 |
|------|------|
| `copilot-instructions.md` | ✅ 决策流程第一步：读取项目 Profile |
| `copilot-instructions.md` | ✅ 新增"场景 0：项目规范强制检查" |
| `copilot-instructions.md` | ✅ 新增"阶段 0：项目规范确认"检查清单 |
| `copilot-instructions.md` | ✅ 新增"项目规范违规"禁止项（最高优先级） |
| `copilot-instructions.md` | ✅ 明确"项目规范 > 通用最佳实践" |
| `profiles/chat.md` | ✅ 新增"架构与技术栈强制规范"章节 |
| `profiles/chat.md` | ✅ 明确"禁止 Service 层" + 原因说明 |
| `profiles/chat.md` | ✅ 明确"强制 Joi" + 正确/错误示例 |
| `profiles/chat.md` | ✅ 明确"强制 Mocha" + 正确/错误示例 |
| `profiles/chat.md` | ✅ 目录结构删除 `service/`，标注历史遗留 |

---

## 🔄 AI 新的执行流程

### 修改前（错误流程）

```yaml
用户: "帮我实现消息设置功能"

AI 执行:
  1. ❌ 直接开始写代码
  2. ❌ 使用通用最佳实践（Service 层 + DTO）
  3. ❌ 使用 Jest 测试框架
  4. ❌ 违反项目规范
```

### 修改后（正确流程）

```yaml
用户: "帮我实现消息设置功能"

AI 执行:
  【场景 0：项目规范强制检查】
  1. ✅ 识别项目: chat
  2. ✅ 读取: guidelines/profiles/chat.md（完整通读）
  3. ✅ 提取规范:
     - 禁止 Service 层 ← 记录！
     - 强制 Joi 验证 ← 记录！
     - 强制 Mocha 测试 ← 记录！
     - 使用 utilsCrud ← 记录！
     - 中文注释 ← 记录！
  4. ✅ 冲突检查:
     - 我想用 Service 层（通用实践）
     - 但 Profile 禁止 → 放弃 Service 层 ✅
  5. ✅ 自我检查:
     - 已读 Profile？YES ✅
     - 知道禁止什么？YES（禁止Service）✅
     - 会用禁止技术？NO ✅
     - 优先项目规范？YES ✅
  
  【场景 A：新增功能】
  6. ✅ 开始写代码（Controller + Utils 模式）
  7. ✅ 使用 Joi 验证
  8. ✅ 使用 Mocha 测试
  9. ✅ 中文注释
  10. ✅ 完全符合项目规范 ✅
```

---

## 🎯 关键改进点

### 1. 优先级明确化

**修改前**：
```
通用最佳实践 ≈ 项目规范（模糊）
```

**修改后**：
```
项目规范 🔴 > copilot-instructions.md 🟠 > 通用最佳实践 🟡
```

### 2. 强制检查前置化

**修改前**：
```
[1] 识别场景
[2] 读取 Profile（可能跳过）
[3] 执行任务
```

**修改后**：
```
[0] 🔴 【强制第一步】读取项目 Profile
[0.1] 🔴 识别禁止项
[0.2] 🔴 项目规范 > 通用实践
[1] 识别场景
[2] 执行任务
```

### 3. 禁止项显式化

**修改前**：
```markdown
## 目录结构
app/
├── service/  # 服务层（业务逻辑）  ← AI 认为允许使用
```

**修改后**：
```markdown
## 架构与技术栈强制规范

### 🔴 架构层次禁止项

**禁止使用 Service 层**:  ← 明确禁止
- ❌ 不创建 `app/service/` 目录
- ❌ 不写业务逻辑 Service 类
- ✅ Controller 直接操作数据库

⚠️ 注意：历史遗留的 `app/service/` 目录不要继续使用
```

### 4. 自我检查机制

**修改后新增**：
```yaml
STEP 5: 自我检查
  在开始写代码前，大声问自己:
  1. "我是否已读取项目 Profile？" → 必须 YES
  2. "我是否知道项目禁止什么？" → 必须 YES
  3. "我是否会使用项目禁止的技术？" → 必须 NO
  4. "我是否优先项目规范而非通用实践？" → 必须 YES
```

---

## 📌 后续建议

### 1. 其他项目规范也需要同步更新

建议检查并更新以下项目的 Profile：
- `profiles/user.md`
- `profiles/push.md`
- `profiles/resource.md`
- `profiles/search.md`
- `profiles/payment.md`

确保每个项目都有：
- ✅ "架构与技术栈强制规范"章节
- ✅ 明确的禁止项清单
- ✅ 正确/错误示例对比

### 2. 定期验证 AI 执行

每次 AI 生成代码后，检查：
- [ ] AI 是否先读取了 Profile？
- [ ] AI 是否遵守了禁止项？
- [ ] AI 是否使用了正确的技术栈？

### 3. 规范持续改进

如果发现 AI 仍然违规：
1. 记录违规场景
2. 分析原因（规范表达不够明确？检查清单不够详细？）
3. 补充规范（参考本次修改方法）

---

## ✅ 验证方法

### 测试场景

**输入**：
```
帮我在 chat 项目实现消息设置功能
```

**期望 AI 执行**：
1. ✅ 先读取 `profiles/chat.md`
2. ✅ 识别禁止项（Service/DTO/Jest）
3. ✅ 生成 Controller + Utils 模式代码
4. ✅ 使用 Joi 验证
5. ✅ 使用 Mocha 测试
6. ✅ 中文注释

**不期望 AI 执行**：
1. ❌ 直接生成 Service 类
2. ❌ 定义 DTO 类
3. ❌ 使用 class-validator
4. ❌ 使用 Jest 测试
5. ❌ 英文注释

---

## 📚 copilot-instructions.md 与 v2.md 联动关系

### 文件职责划分

| 文件 | 职责 | 使用场景 |
|------|------|---------|
| **copilot-instructions.md** | 快速决策树、执行检查清单 | AI 首次接收任务时的**快速查询手册** |
| **v2.md** | 20章节详细规范、完整执行流程 | AI 执行具体任务时的**详细参考文档** |

### 联动机制

```yaml
AI 接收任务:
  ↓
读取 copilot-instructions.md:
  - 快速决策流程（场景0最前置）
  - 场景触发器（6个场景）
  - 执行检查清单（5个阶段）
  - 禁止操作清单
  ↓
根据场景读取 v2.md 对应章节:
  - 场景0 → v2.md "场景0"章节
  - 场景A → v2.md 第3.1章
  - 场景B → v2.md Bug模板
  - 场景C → v2.md 第20章
  - ...
  ↓
执行任务:
  - 遵循 v2.md 详细规范
  - 使用 copilot-instructions.md 检查清单验证
```

### 本次联动更新

| 更新位置 | 更新内容 | 同步状态 |
|---------|---------|---------|
| **copilot-instructions.md** | ✅ 决策流程添加"场景0" | 已完成 |
| **copilot-instructions.md** | ✅ 新增"场景0：项目规范强制检查" | 已完成 |
| **copilot-instructions.md** | ✅ 新增"阶段0：项目规范确认"检查清单 | 已完成 |
| **copilot-instructions.md** | ✅ 新增"项目规范违规"禁止项 | 已完成 |
| **v2.md** | ✅ 立即执行规则添加"第0优先级" | 已完成 |
| **v2.md** | ✅ 关键决策点添加"场景0" | 已完成 |
| **v2.md** | ✅ 新增"场景0：项目规范强制检查"章节 | 已完成 |
| **v2.md** | ✅ 目录添加"场景0"链接 | 已完成 |
| **profiles/chat.md** | ✅ 新增"架构与技术栈强制规范"章节 | 已完成 |

### 跨文件引用关系

```
copilot-instructions.md (执行入口)
  ↓ 引用
v2.md (详细规范)
  ↓ 引用
profiles/chat.md (项目特定配置)
  ↓ 覆盖
v2.md 通用规范
```

**优先级**:
```
项目Profile 🔴 > copilot-instructions.md 🟠 > v2.md 🟡 > 通用最佳实践 🟢
```

---

## 📝 总结

**问题根源**：AI 优先使用通用最佳实践，而非项目特定规范

**解决方案**：
1. **通用规范层面**：强化项目规范优先级，新增"场景 0"前置检查
2. **项目规范层面**：显式声明禁止项，提供正确/错误示例

**核心原则**：
```
项目规范 🔴 > copilot-instructions.md 🟠 > 通用最佳实践 🟡
```

**关键机制**：
- ✅ 强制前置检查（场景 0 + 阶段 0）
- ✅ 显式禁止项清单
- ✅ 自我检查机制（5个核心问题）
- ✅ 冲突解决规则（项目规范绝对优先）

**预期效果**：
- AI 在写代码前必须先读取项目 Profile
- AI 必须识别并遵守项目禁止项
- AI 必须优先项目规范而非个人"优化"

---

**文档版本**: v1.0  
**创建日期**: 2025-11-10  
**作者**: AI 助手（基于用户反馈改进）

