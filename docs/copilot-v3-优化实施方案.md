# copilot-instructions.md 优化实施方案

> **优化目标**: 从 1000行 → 300行，减少 70% 冗余内容  
> **优化原则**: 保留索引 + 核心原则，详细内容移至 v2.md  
> **实施日期**: 2025-11-10

---

## 📊 优化前后对比

| 指标 | 优化前 | 优化后 | 改善 |
|------|-------|-------|------|
| 文件行数 | ~1000行 | ~300行 | ↓ 70% |
| 场景详情 | 完整版（50行×6） | 索引版（1行×6） | ↓ 95% |
| 跳转次数 | 10次 | 3次 | ↓ 70% |
| 维护位置 | 12处 | 6处 | ↓ 50% |
| 查找时间 | 需要滚动1000行 | 快速定位 | ↑ 80% |

---

## 🚀 优化后的 copilot-instructions.md（v3.0）

```markdown
# AI 助手执行规范 v3.0

> **角色定位**: 智能执行代理 - 快速决策 + 跳转详细规范  
> **核心原则**: 项目规范 > 通用最佳实践

---

## 🚀 快速决策流程（3步）

```
用户请求
    ↓
1. 🔴 读取项目 Profile → guidelines/profiles/<project>.md
    ↓
2. 🔴 识别场景 → 见下方场景索引表
    ↓
3. 🔴 跳转 v2.md 对应章节 → 读取详细规范并执行
```

---

## 🔴 核心原则（必读）

### 优先级链条
```
项目 Profile 🔴 > copilot-instructions.md 🟠 > v2.md 🟡 > 通用最佳实践 🟢
```

### 3大红线
1. **项目规范绝对优先**: Profile 明确禁止的，即使是"好实践"也必须禁止
2. **场景 0 强制前置**: 任何代码任务前必须先执行场景 0（读取 Profile）
3. **5个核心问题自检**: 详见 v2.md 场景 0 STEP 5

### 冲突解决规则
```yaml
IF: Profile 规范 与 通用最佳实践 冲突
THEN: 🔴 无条件遵守 Profile 规范

示例:
  Profile: "禁止 Service 层" vs 通用实践: "推荐 Service 层"
  → ✅ 遵守 Profile（禁止 Service 层）
```

---

## 📑 场景索引（快速跳转）

### 决策矩阵

| 用户请求关键词 | 场景 | 详细规范 |
|--------------|------|---------|
| 任何代码任务 | 🔴 场景 0：项目规范检查 | [v2.md 场景0](../guidelines/v2.md#场景-0-项目规范强制检查-所有场景前必执行) |
| "实现"、"添加"、"新增"、"修改"功能 | 场景 A：功能新增/修改 | [v2.md 场景A](../guidelines/v2.md#场景-a-功能新增修改-强制四要素) |
| "Bug"、"错误"、"异常"、"不工作" | 场景 B：Bug 修复 | [v2.md 场景B](../guidelines/v2.md#场景-b-bug-修复-强制记录分析) |
| "删除"、"重构"、">100行" | 场景 C：大规模编辑 | [v2.md 场景C](../guidelines/v2.md#场景-c-大规模编辑-强制脚本模式) |
| "审查"、"检查"、"优化" | 场景 D：代码审查 | [v2.md 场景D](../guidelines/v2.md#场景-d-代码审查-强制安全检查) |
| "更新文档"、"修改 README" | 场景 E：文档更新 | [v2.md 场景E](../guidelines/v2.md#场景-e-文档更新判断-决策矩阵) |
| "查询"、"分析"、"统计"数据 | 场景 G：数据库查询 | [v2.md 场景G](../guidelines/v2.md#场景-g-数据库查询与分析-主动数据支持) |

**⚠️ 注意**: 所有场景前必须先执行 [场景 0](../guidelines/v2.md#场景-0-项目规范强制检查-所有场景前必执行)

---

## 🚨 禁止操作（红线）

### 项目规范违规（最严重）🔴
- ❌ 未读取项目 Profile 就开始写代码
- ❌ 使用项目明确禁止的技术（如 chat 项目禁止 Service 层）
- ❌ 使用项目未指定的验证库（如强制 Joi 但用了 class-validator）
- ❌ 使用项目未指定的测试框架（如强制 Mocha 但用了 Jest）
- ❌ 认为"通用最佳实践"比"项目规范"更重要

### 代码质量违规 🔴
- ❌ 未添加测试就修改功能代码
- ❌ 修改 API 但不更新文档
- ❌ 在日志中记录密码/token/连接串

### 工具使用违规 🟠
- ❌ 使用 multi_edit 删除 >100行内容（应使用 PowerShell 脚本）
- ❌ 未备份就执行大规模编辑
- ❌ 未读取 Profile 就调用 MCP（数据库操作）

---

## 📚 详细规范入口

**完整规范**: [guidelines/v2.md](../guidelines/v2.md)

**快速入口**:
- 🤖 [AI 执行速查](../guidelines/v2.md#ai-执行速查-优先阅读)
- 📑 [场景触发器](../guidelines/v2.md#ai-决策指南场景触发器)
- 📖 [20个详细章节](../guidelines/v2.md#1-基线风格与语言)

**项目配置**: [guidelines/profiles/](../profiles/)

---

## 🔄 执行流程示例

### 示例 1: 实现新功能

```yaml
用户: "帮我在 chat 项目实现消息设置功能"

AI 执行:
  1. 🔴 场景识别: 场景 0 + 场景 A
  2. 🔴 读取 Profile: guidelines/profiles/chat.md
     - 识别: 禁止 Service 层、强制 Joi、强制 Mocha
  3. 🔴 跳转规范: v2.md 场景 A
     - 读取: 功能新增完整流程
  4. ✅ 执行任务:
     - 生成 Controller（无 Service）
     - 使用 Joi 验证
     - 使用 Mocha 测试
  5. ✅ 提交验证
```

### 示例 2: 修复 Bug

```yaml
用户: "用户反馈行程创建失败"

AI 执行:
  1. 🔴 场景识别: 场景 B
  2. 🔴 跳转规范: v2.md 场景 B
     - 读取: Bug 修复完整流程
  3. 🔴 使用模板: Bug 分析模板
  4. ✅ 执行修复 + 记录分析
```

---

## 💡 快速提示

### 不确定场景？
→ 查看 [场景决策矩阵](#决策矩阵)

### 忘记项目规范？
→ 重新执行 [场景 0](../guidelines/v2.md#场景-0)

### 需要详细说明？
→ 跳转 [v2.md](../guidelines/v2.md)

---

**版本**: v3.0  
**更新日期**: 2025-11-10  
**文件大小**: ~300行（从 v2.1 的 1000行优化）  
**维护者**: 请同步更新 [v2.md](../guidelines/v2.md)
```

---

## 📝 实施步骤

### 步骤 1: 备份当前文件
```powershell
Copy-Item .github/copilot-instructions.md .github/copilot-instructions.md.v2.1.backup
```

### 步骤 2: 替换为优化版本
- 将上述优化版内容替换到 `copilot-instructions.md`

### 步骤 3: 更新 v2.md 引用
- 确保 v2.md 的场景 0-E 有完整的详细描述
- 确保所有章节链接正确

### 步骤 4: 验证
- [ ] 所有场景链接可跳转
- [ ] 决策矩阵关键词覆盖常见场景
- [ ] 核心原则清晰明确
- [ ] 禁止操作分类清晰

### 步骤 5: 测试
用以下场景测试 AI 执行流程:
1. "帮我实现 XX 功能" → 应跳转场景 A
2. "修复 XX Bug" → 应跳转场景 B
3. "查询 chat 数据" → 应先读 Profile 再执行

---

## ✅ 预期效果

### 查找效率
- **优化前**: 需要在 1000行中滚动查找
- **优化后**: 场景索引表快速定位

### 维护成本
- **优化前**: 场景详情在两个文件，需同步维护
- **优化后**: 场景详情仅在 v2.md，copilot 仅维护索引

### AI 理解
- **优化前**: 需要读大量内容才能找到关键信息
- **优化后**: 核心原则 + 场景索引 + 跳转详情

### 人类维护
- **优化前**: 不清楚哪个文件该写什么
- **优化后**: copilot = 索引，v2.md = 详情

---

**实施人**: 待定  
**实施日期**: 待定  
**预计耗时**: 2小时

