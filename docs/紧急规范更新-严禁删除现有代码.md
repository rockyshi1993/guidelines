# 紧急规范更新：严禁删除现有代码

> **更新日期**: 2025-01-12  
> **更新原因**: 防止AI助手误删现有代码导致生产环境故障  
> **严重级别**: 🔴💀 最高级别  
> **影响范围**: 所有AI辅助开发任务

---

## 🔥 问题起因

### 真实事故案例

**时间**: 2025-01-12  
**项目**: chat  
**文件**: `app/routes/home/index.ts`  
**操作**: AI助手在添加商业化路由时，误删了5个现有的import和路由调用

**被删除的代码**:
```typescript
// 被删除的 import
- import selectorGroup from './selector';
- import proposalGroup from './proposal';
- import proposalPoiGroup from './proposal_poi';
- import proposalFlightGroup from './proposal_flight';
- import adviserConversationGroup from "./adviser_conversation";

// 被删除的路由调用
- selectorGroup(app, _groupRouter)
- proposalGroup(app, _groupRouter)
- proposalPoiGroup(app, _groupRouter)
- proposalFlightGroup(app, _groupRouter)
- adviserConversationGroup(app, _groupRouter)
```

**直接后果**:
1. ❌ `selectorGroup` 相关的所有API立即返回404
2. ❌ `proposalGroup` 相关的所有API立即返回404
3. ❌ `proposalPoiGroup` 相关的所有API立即返回404
4. ❌ `proposalFlightGroup` 相关的所有API立即返回404
5. ❌ `adviserConversationGroup` 相关的所有API立即返回404

**影响范围**:
- 🔴 5个功能模块完全不可用
- 🔴 所有依赖这些API的前端功能崩溃
- 🔴 所有正在使用这些功能的用户受影响
- 🔴 如果部署到生产环境，造成严重的用户体验问题

**修复时间**: 需要紧急回滚或手动恢复代码

---

## 📋 新增规范

### 1. 在 `guidelines/v2.md` 中添加

**位置**: AI执行速查 → 立即执行规则

**新增内容**:
```yaml
🔴 第1优先级：严格禁止删除/破坏现有代码（关键规则）

❌ 绝对禁止的危险操作（违反将导致严重后果）:

1. 禁止删除现有的import语句
   原因: 删除import会导致现有路由/功能失效，影响生产环境
   
2. 禁止删除现有的路由调用
   原因: 删除路由调用等同于下线功能，影响所有用户
   
3. 禁止删除现有的函数/方法
   原因: 可能被其他模块依赖，删除会引发连锁失败
   
4. 禁止删除现有的配置项
   原因: 现有功能依赖配置，删除导致功能异常

✅ 正确的新增代码方式:
  - 仅在文件末尾或指定位置添加新代码
  - 仅添加新的import语句，不删除现有import
  - 仅添加新的路由调用，不删除现有路由
  - 如需修改，使用精确的replace而非删除重写
  
⚠️ 修改前的强制检查:
  [ ] 是否阅读了整个文件？
  [ ] 是否理解了每个import的用途？
  [ ] 是否确认删除不会影响现有功能？
  [ ] 是否有其他方式避免删除？
  
🔍 验证方法:
  - 使用 git diff 检查改动
  - 确保没有 "- import XXX" 的删除行
  - 确保没有 "- XXXGroup(app, _groupRouter)" 的删除行
  - 任何删除操作必须有明确的理由和用户确认
```

### 2. 在 `copilot-instructions.md` 中添加

**位置1**: 绝对禁止（Absolute Forbidden）部分

**扩展内容**: 添加"严格禁止删除现有代码"章节，包含：
- 5种禁止删除的代码类型
- 正确的新增代码方式
- 修改文件前的强制自检清单（6项）
- 提交前的验证方法
- 真实案例教训

**位置2**: 强制断点（MUST HALT）部分

**新增**: 断点6 - 检测到删除现有代码 🔴💀

```yaml
触发条件: 
  - git diff 显示有 "- import XXX" 删除行
  - git diff 显示有 "- function XXX()" 删除行
  - git diff 显示有 "- XXXGroup(app, ...)" 删除行

必须执行:
  - 🛑 立即停止所有操作
  - 🔴 立即恢复被删除的代码
  - ✅ 输出严重错误警告
  - ✅ 显示被删除的内容
  - ✅ 说明影响
  - ✅ 使用 git diff 验证恢复成功
  - ✅ 重新规划实现方式（仅添加，不删除）
```

---

## ✅ 执行效果验证

### 预期效果

1. **阻止删除**: AI助手在修改文件时，会避免删除任何现有代码
2. **自动检查**: 每次修改后，AI助手会主动使用 `git diff` 检查是否有删除操作
3. **及时恢复**: 如果误删，立即检测并恢复
4. **用户确认**: 任何删除操作必须先获得用户明确确认

### 验证方法

模拟场景：AI助手添加新路由

**正确行为**:
1. ✅ 只添加新的import语句
2. ✅ 只添加新的路由调用
3. ✅ 不删除任何现有import
4. ✅ 不删除任何现有路由调用
5. ✅ 使用 `git diff` 验证改动
6. ✅ 向用户确认改动正确

**错误行为**（应该被阻止）:
1. ❌ 删除现有import
2. ❌ 删除现有路由调用
3. ❌ 未经用户确认就删除代码

---

## 📊 规范优先级

```
断点6：删除现有代码 🔴💀 (最高严重级别)
    ↓
断点0-5：其他违规操作 🔴 (严重级别)
    ↓
场景0：项目规范检查 🔴 (必须执行)
    ↓
其他规范 🟠🟡🟢 (按优先级执行)
```

---

## 🎯 关键要点

1. **永远不要删除现有代码，除非用户明确要求**
2. **添加新功能 = 只添加，不删除**
3. **修改文件前，先完整阅读整个文件**
4. **每次修改后，使用 git diff 验证**
5. **任何删除操作，必须获得用户确认**

---

## 📝 相关文件

- ✅ `guidelines/guidelines/v2.md` - 已更新（第1优先级规则）
- ✅ `.github/copilot-instructions.md` - 已更新（扩展绝对禁止部分 + 断点6）
- ✅ 本文档 - 紧急规范更新说明

---

**更新人**: AI Assistant  
**审核人**: 待审核  
**生效日期**: 2025-01-12  
**状态**: ✅ 已完成更新

