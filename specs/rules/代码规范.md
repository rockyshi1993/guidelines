# v3 代码规范

> **文件**: specs/rules/代码规范.md  
> **版本**: v3.0  
> **日期**: 2025-11-20  
> **说明**: AI 生成代码的质量规范

---

## 📑 目录导航

> 🔴 = 必须遵守 | 🟡 = 建议遵守 | 🟢 = 参考

- [命名规范](#-命名规范) 🔴 - 变量/函数/类/文件命名规则
  - [JavaScript/TypeScript 命名规范](#javascripttypescript-命名规范) 🔴 - camelCase/PascalCase/UPPER_SNAKE_CASE
  - [文件命名规范](#文件命名规范) 🔴 - kebab-case.js
- [代码结构规范](#-代码结构规范) 🔴 - 函数/类/模块结构要求
  - [函数规范](#函数规范) 🔴 - 长度≤50行，参数≤5个
  - [类规范](#类规范) 🔴 - 单一职责原则
  - [模块规范](#模块规范) 🔴 - 清晰的导入/导出
- [注释规范](#-注释规范) 🔴 - JSDoc和行内注释格式
  - [JSDoc 注释规范](#jsdoc-注释规范) 🔴 - 函数/类必须有JSDoc
  - [行内注释规范](#行内注释规范) 🟡 - 复杂逻辑必须注释
- [代码质量规范](#-代码质量规范) 🔴 - 复杂度/重复率/长度限制
  - [复杂度要求](#复杂度要求) 🔴 - 圈复杂度≤10
  - [代码重复](#代码重复) 🔴 - 重复率≤5%
  - [代码长度](#代码长度) 🔴 - 函数≤50行，文件≤500行
- [错误处理规范](#-错误处理规范) 🔴 - 异常处理和错误传递
  - [异步函数错误处理](#异步函数错误处理) 🔴 - 必须try-catch
  - [同步函数错误处理](#同步函数错误处理) 🔴 - 合理的错误返回
- [安全规范](#-安全规范) 🔴 - 禁止硬编码敏感信息
- [代码检查清单](#-代码检查清单) 🔴 - Lint/Format/复杂度/测试覆盖率
- [Profile 优先](#-profile-优先) 🟡 - 项目规范优先机制

---

## 📚 相关规范文件

**代码生成时必须配合使用**:
- 📦 [流程.md](../core/流程.md) 🔴 - STEP 9使用本规范
- 📐 [安全规范.md](./安全规范.md) 🔴 - 必须同时检查敏感信息
- 📐 [测试规范.md](./测试规范.md) 🔴 - 代码完成后生成测试

**相关规范**:
- 📐 [API规范.md](./API规范.md) 🟡 - API接口代码需遵守
- 📐 [文档规范.md](./文档规范.md) 🟡 - 代码注释转文档

**Profile优先**:
- 🔴 如果项目Profile定义了不同的命名规范，优先使用项目规范
- 🔴 如果项目禁止某些模式（如Service层/DTO），必须遵守

---

## 📋 命名规范

### JavaScript/TypeScript 命名规范

```yaml
变量名:
  格式: camelCase
  示例: userName, orderList, isActive
  禁止: user_name, UserName, USERNAME

常量名:
  格式: UPPER_SNAKE_CASE
  示例: MAX_COUNT, API_URL, DEFAULT_TIMEOUT
  禁止: maxCount, MaxCount, max_count

函数名:
  格式: camelCase
  示例: getUserById, calculateTotal, isValid
  规则: 
    - 动词开头
    - 描述功能
    - 布尔函数用 is/has/can 开头

类名:
  格式: PascalCase
  示例: UserService, OrderController, DatabaseConnection
  禁止: userService, user_service

接口名:
  格式: PascalCase，可选I前缀
  示例: IUserService, UserService
  禁止: iUserService, userService

类型名:
  格式: PascalCase
  示例: UserType, OrderStatus
  禁止: userType, user_type

枚举名:
  格式: PascalCase
  示例: OrderStatus, UserRole
  成员: UPPER_SNAKE_CASE
  示例: OrderStatus.PENDING, UserRole.ADMIN

文件名:
  格式: kebab-case
  示例: user-service.js, order-controller.ts
  禁止: UserService.js, user_service.js

私有变量/方法:
  格式: _camelCase 或 #camelCase
  示例: _privateMethod, #privateField
```

### Python 命名规范

```yaml
变量名:
  格式: snake_case
  示例: user_name, order_list, is_active

常量名:
  格式: UPPER_SNAKE_CASE
  示例: MAX_COUNT, API_URL, DEFAULT_TIMEOUT

函数名:
  格式: snake_case
  示例: get_user_by_id, calculate_total, is_valid

类名:
  格式: PascalCase
  示例: UserService, OrderController

模块名:
  格式: snake_case
  示例: user_service.py, order_controller.py

私有变量/方法:
  格式: _snake_case
  示例: _private_method, _private_field
```

---

## 🏗️ 代码结构规范

### 函数规范

```yaml
函数长度:
  最大行数: 50行
  建议: 20-30行
  
  IF: 函数超过50行
  THEN:
    - 拆分为多个小函数
    - 提取公共逻辑
    - 使用组合模式

参数数量:
  最大数量: 5个
  建议: 2-3个
  
  IF: 参数超过5个
  THEN:
    - 使用对象传参
    - 使用配置对象
    - 考虑重构

嵌套层级:
  最大层级: 3层
  建议: 1-2层
  
  IF: 嵌套超过3层
  THEN:
    - 提前返回（guard clauses）
    - 提取为独立函数
    - 使用策略模式

圈复杂度:
  最大值: 10
  建议: 1-5
  
  IF: 复杂度超过10
  THEN:
    - 拆分函数
    - 简化逻辑
    - 使用表驱动
```

### 文件规范

```yaml
文件长度:
  最大行数: 300行
  建议: 100-200行
  
  IF: 文件超过300行
  THEN:
    - 拆分为多个文件
    - 按职责分离
    - 使用模块化

类长度:
  最大方法数: 20个
  建议: 5-10个
  
  IF: 方法超过20个
  THEN:
    - 拆分为多个类
    - 使用组合
    - 考虑设计模式

单一职责:
  原则: 一个类/函数只做一件事
  
  检查方法:
    - 能否用一句话描述功能？
    - 修改是否只有一个原因？
    - 是否可以独立测试？
```

### 模块组织

```yaml
文件组织顺序:
  1. import/require 语句
  2. 类型定义/接口
  3. 常量定义
  4. 工具函数
  5. 主要类/函数
  6. export 语句

import 分组:
  1. 标准库 import
  2. 第三方库 import
  3. 项目内部 import
  4. 相对路径 import
  
  每组之间空一行

示例:
  // 标准库
  import fs from 'fs';
  import path from 'path';
  
  // 第三方库
  import express from 'express';
  import lodash from 'lodash';
  
  // 项目内部
  import { UserService } from '@/services';
  import { config } from '@/config';
  
  // 相对路径
  import { helper } from './helper';
  import { types } from './types';
```

---

## 💬 注释规范

### 必须注释的地方

```yaml
文件头注释:
  必须包含:
    - 文件描述
    - 作者（可选）
    - 创建日期（可选）
  
  格式:
    /**
     * 用户服务模块
     * 
     * 提供用户CRUD操作
     * @module UserService
     */

函数注释（public函数必须）:
  必须包含:
    - 功能描述
    - 参数说明
    - 返回值说明
    - 异常说明（如有）
  
  格式 (JSDoc):
    /**
     * 根据ID获取用户信息
     * 
     * @param {string} userId - 用户ID
     * @param {Object} options - 查询选项
     * @param {boolean} options.includeDeleted - 是否包含已删除用户
     * @returns {Promise<User>} 用户对象
     * @throws {NotFoundError} 用户不存在时抛出
     */
    async function getUserById(userId, options = {}) {
      // ...
    }

类注释:
  必须包含:
    - 类的职责
    - 使用示例（复杂类）
  
  格式:
    /**
     * 用户服务类
     * 
     * 负责用户数据的增删改查操作
     * 
     * @example
     * const service = new UserService();
     * const user = await service.getUserById('123');
     */
    class UserService {
      // ...
    }

复杂逻辑注释:
  必须注释:
    - 算法逻辑
    - 业务规则
    - 临时方案（带TODO）
    - 性能优化
    - 安全考虑
  
  示例:
    // 使用二分查找优化性能（数据量 > 1000时）
    if (dataList.length > 1000) {
      return binarySearch(dataList, target);
    }
    
    // TODO: 临时方案，等待API v2.0后改用新接口
    const result = await legacyAPI.fetch();
    
    // HACK: 绕过第三方库的bug，已提issue #123
    const workaround = data.map(item => ({ ...item }));
```

### 不需要注释的地方

```yaml
不需要注释:
  - 显而易见的代码
  - 变量声明（除非复杂）
  - 简单的getter/setter
  - 自解释的函数名
  
  ❌ 不好的注释:
    // 获取用户名
    const userName = user.name;
    
    // 返回结果
    return result;
  
  ✅ 好的代码（自解释，不需要注释）:
    const userName = user.name;
    return result;
```

### 注释风格

```yaml
行内注释:
  格式: // 注释内容
  位置: 代码上方或右侧
  
  示例:
    // 验证用户权限
    if (!user.hasPermission('edit')) {
      throw new Error('Permission denied');
    }

块注释:
  格式: /* ... */ 或 /** ... */
  用途: 文档注释、多行说明
  
TODO注释:
  格式: // TODO: 说明
  用途: 标记待完成的工作
  
  示例:
    // TODO: 添加缓存层提升性能
    // TODO(张三): 等待后端API完成后集成
    // TODO [2025-12-01]: 优化算法，目标响应时间<100ms

FIXME注释:
  格式: // FIXME: 说明
  用途: 标记需要修复的问题
  
  示例:
    // FIXME: 这里有内存泄漏风险
    // FIXME: 边界条件未处理

HACK注释:
  格式: // HACK: 说明
  用途: 标记临时方案或绕过问题
  
  示例:
    // HACK: 临时绕过第三方库bug
```

---

## 🎨 代码格式规范

### 缩进和空格

```yaml
缩进:
  使用: 2个空格（JavaScript/TypeScript）
  使用: 4个空格（Python）
  禁止: Tab字符
  
  示例:
    function example() {
      if (condition) {
        doSomething();
      }
    }

空格使用:
  运算符两侧: 加空格
    ✅ const sum = a + b;
    ❌ const sum=a+b;
  
  逗号后: 加空格
    ✅ function(a, b, c)
    ❌ function(a,b,c)
  
  关键字后: 加空格
    ✅ if (condition)
    ❌ if(condition)
  
  函数名和括号: 不加空格
    ✅ function example()
    ❌ function example ()

空行使用:
  函数间: 空1行
  逻辑块间: 空1行
  文件开头: 不空行
  文件结尾: 空1行
  
  示例:
    function first() {
      // ...
    }
                    ← 空1行
    function second() {
      // ...
    }
```

### 行长度

```yaml
最大行长度:
  JavaScript/TypeScript: 100字符
  Python: 79字符
  
  IF: 超过最大长度
  THEN:
    - 换行
    - 参数分行
    - 链式调用分行

换行规则:
  运算符: 放在行尾
    const result = longVariableName +
      anotherLongVariable +
      oneMoreVariable;
  
  函数参数: 每个参数一行
    function example(
      firstParameter,
      secondParameter,
      thirdParameter
    ) {
      // ...
    }
  
  链式调用: 每个方法一行
    const result = data
      .filter(item => item.active)
      .map(item => item.value)
      .reduce((sum, val) => sum + val, 0);
```

### 括号和引号

```yaml
大括号:
  样式: K&R风格（开括号在行尾）
  单行: 可省略，但建议保留
  
  ✅ 推荐:
    if (condition) {
      doSomething();
    }
  
  ⚠️ 可接受（单行）:
    if (condition) doSomething();
  
  ❌ 不推荐（省略括号）:
    if (condition)
      doSomething();

引号:
  JavaScript/TypeScript: 单引号 '
  Python: 单引号 '
  JSON: 双引号 "
  
  示例:
    const str = 'Hello';
    const obj = { "key": "value" };  // JSON
```

---

## 🔒 代码质量规范

### 禁止使用

```yaml
禁止使用的特性:
  JavaScript:
    - var（使用 const/let）
    - eval()
    - with
    - == 和 !=（使用 === 和 !==）
    - 全局变量污染
  
  通用:
    - 魔法数字（使用常量）
    - 硬编码（使用配置）
    - 深度嵌套（>3层）
    - 重复代码

示例:
  ❌ 不好:
    if (status == 1) {  // 魔法数字 + ==
      // ...
    }
  
  ✅ 好:
    const STATUS_ACTIVE = 1;
    if (status === STATUS_ACTIVE) {
      // ...
    }
```

### 错误处理

```yaml
必须处理错误:
  - 所有async函数必须try-catch
  - 所有Promise必须catch
  - 所有可能失败的操作必须处理
  
  示例:
    ✅ 好:
      try {
        const result = await someAsyncOperation();
        return result;
      } catch (error) {
        logger.error('Operation failed:', error);
        throw new CustomError('Failed to complete operation');
      }
    
    ❌ 不好:
      const result = await someAsyncOperation();
      return result;

错误类型:
  - 使用自定义错误类
  - 包含错误码
  - 包含上下文信息
  
  示例:
    class ValidationError extends Error {
      constructor(message, field) {
        super(message);
        this.name = 'ValidationError';
        this.code = 'VALIDATION_ERROR';
        this.field = field;
      }
    }
```

### 安全规范

```yaml
禁止硬编码:
  - 密码
  - API密钥
  - 数据库连接字符串
  - 敏感URL
  
  ❌ 禁止:
    const password = 'admin123';
    const apiKey = 'sk_live_xxxxx';
  
  ✅ 使用:
    const password = process.env.DB_PASSWORD;
    const apiKey = process.env.API_KEY;

输入验证:
  - 所有用户输入必须验证
  - 使用白名单验证
  - 防止SQL注入
  - 防止XSS攻击
  
  示例:
    function validateEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        throw new ValidationError('Invalid email format');
      }
    }

SQL查询:
  - 使用参数化查询
  - 禁止字符串拼接
  
  ❌ 禁止:
    const sql = `SELECT * FROM users WHERE id = ${userId}`;
  
  ✅ 使用:
    const sql = 'SELECT * FROM users WHERE id = ?';
    db.query(sql, [userId]);
```

---

## 📊 代码度量标准

### 质量指标

```yaml
圈复杂度（Cyclomatic Complexity）:
  优秀: 1-5
  良好: 6-10
  警告: 11-20
  危险: >20
  
  IF: 复杂度 > 10
  THEN: 必须重构

认知复杂度（Cognitive Complexity）:
  优秀: 0-5
  良好: 6-15
  警告: 16-25
  危险: >25

代码重复率:
  最大值: 5%
  
  IF: 重复率 > 5%
  THEN: 提取公共函数/模块

注释率:
  最小值: 10%
  最大值: 30%
  
  说明:
    - 过少注释：代码不清晰
    - 过多注释：代码自解释性差
```

### 性能规范

```yaml
时间复杂度:
  优先: O(1), O(log n), O(n)
  可接受: O(n log n)
  警告: O(n²)
  禁止: O(n³) 及以上（小数据量除外）

空间复杂度:
  优先: O(1)
  可接受: O(n)
  警告: O(n²)

数组操作:
  - 优先使用map/filter/reduce
  - 避免在循环中创建函数
  - 避免不必要的数组复制

对象操作:
  - 优先使用Object.keys/values/entries
  - 避免频繁的Object.assign
  - 使用对象解构
```

---

## ✅ 代码检查清单

### 提交前检查

```yaml
必须检查:
  ✅ 代码通过 lint 检查
  ✅ 代码通过 format 检查
  ✅ 所有测试通过
  ✅ 测试覆盖率 ≥ 80%
  ✅ 没有 console.log/debugger
  ✅ 没有 TODO/FIXME（或已记录）
  ✅ 没有硬编码敏感信息
  ✅ 所有函数有注释
  ✅ 复杂逻辑有说明
  ✅ 错误处理完善
```

### 自动化检查工具

```yaml
JavaScript/TypeScript:
  Lint: ESLint
  Format: Prettier
  类型检查: TypeScript
  
  配置示例:
    {
      "extends": ["eslint:recommended"],
      "rules": {
        "no-var": "error",
        "prefer-const": "error",
        "eqeqeq": ["error", "always"],
        "complexity": ["warn", 10],
        "max-len": ["warn", 100],
        "max-lines-per-function": ["warn", 50]
      }
    }

Python:
  Lint: Pylint, Flake8
  Format: Black
  类型检查: mypy
```

---

**文件创建**: 2025-11-20  
**最后更新**: 2025-11-20  
**状态**: ✅ 完整

