# v3 紧急情况处理规范

> **文件**: specs/core/紧急处理.md  
> **版本**: v3.0  
> **日期**: 2025-11-21  
> **说明**: AI处理紧急情况的标准流程

---

## 📑 目录导航

> 🔴 = 立即处理 | 🟡 = 重要 | 🟢 = 记录

- [紧急情况定义](#-紧急情况定义) 🔴 - 什么算紧急情况
- [情况1: 用户紧急停止](#-情况1-用户紧急停止) 🔴 - Ctrl+C/取消
- [情况2: 系统资源不足](#-情况2-系统资源不足) 🔴 - 内存/磁盘
- [情况3: 严重错误](#-情况3-严重错误) 🔴 - 致命异常
- [情况4: 时间超限](#-情况4-时间超限) 🟡 - 执行过久
- [情况5: 工具不可用](#-情况5-工具不可用) 🟡 - MCP/工具失败
- [情况6: 数据丢失风险](#-情况6-数据丢失风险) 🔴 - 状态异常
- [紧急恢复流程](#-紧急恢复流程) 🔴 - 如何恢复
- [紧急联系机制](#-紧急联系机制) 🟢 - 人工支持

---

## 🚨 紧急情况定义

### 什么算紧急情况

```yaml
🔴 立即处理 (Critical):
  - 用户明确要求停止
  - 系统资源耗尽
  - 致命错误无法继续
  - 数据丢失风险
  - 安全漏洞发现

🟡 需要注意 (Warning):
  - 执行时间过长
  - 工具调用失败
  - 循环接近上限
  - 磁盘空间不足

🟢 记录即可 (Info):
  - 网络波动
  - 轻微延迟
  - 可恢复的小错误
```

### 紧急情况处理原则

```yaml
原则1: 安全第一
  - 保存已完成工作
  - 不造成数据丢失
  - 不留下脏数据

原则2: 状态可恢复
  - 保存当前状态
  - 记录中断位置
  - 提供恢复选项

原则3: 信息完整
  - 生成详细报告
  - 记录中断原因
  - 记录恢复方法

原则4: 用户知情
  - 明确告知发生了什么
  - 说明已采取的措施
  - 提供后续选项
```

---

## 🛑 情况1: 用户紧急停止

**触发条件**:
- 用户输入: "停止" / "取消" / "退出"
- 系统信号: Ctrl+C / SIGINT
- 用户关闭终端/IDE

**处理流程**:

```yaml
STEP 1: 立即响应
  - 停止当前操作
  - 不再执行新的STEP
  - 取消pending的工具调用

STEP 2: 保存当前状态
  位置: /reports/{模块名}/.temp/emergency-state.json
  
  内容:
    - taskId
    - currentStep
    - completedSteps: [...]
    - filesGenerated: [...]
    - userConfirmations: [...]
    - interruptReason: "user_requested"
    - timestamp

STEP 3: 生成中断报告
  位置: /reports/{模块名}/.temp/interrupt-report.md
  
  内容:
    ## 任务中断报告
    
    中断时间: 2025-11-21 10:30:00
    中断原因: 用户要求停止
    执行进度: STEP 14 / 22 (64%)
    
    已完成:
      ✅ STEP 0-13
      ✅ 代码已生成
      ✅ 测试已运行
    
    未完成:
      ⏸️ STEP 14 用户确认测试结果
      ⏸️ STEP 15-22
    
    已生成文件:
      - src/user-service.js
      - test/user-service.test.js

STEP 4: 询问用户意图
  选项:
    [K] 保留已完成部分 (Keep)
    [D] 删除所有生成文件 (Delete)
    [P] 暂停，稍后恢复 (Pause)
  
  默认: 如果无响应，选择 [P] 暂停

STEP 5: 执行用户选择
  
  IF 选择 K (保留):
    - 保留所有已生成文件
    - 状态文件移动到 archive/
    - 清理锁文件
    - 生成保留清单
  
  IF 选择 D (删除):
    - 删除所有已生成文件
    - 删除状态文件
    - 清理锁文件
    - 恢复到任务开始前状态
  
  IF 选择 P (暂停):
    - 保留状态文件 (用于恢复)
    - 保留所有已生成文件
    - 保留锁文件
    - 提示恢复方法

STEP 6: 记录审计日志
  auditLog.push({
    event: 'emergency_stop',
    reason: 'user_requested',
    step: currentStep,
    action_taken: userChoice,
    files_affected: [...],
    timestamp: Date.now()
  });

STEP 7: 输出最终消息
  ⚠️ 任务已停止
  
  原因: 用户要求停止
  进度: 64% (STEP 14/22)
  
  已保存:
    - 状态文件: /reports/user-service/.temp/emergency-state.json
    - 中断报告: /reports/user-service/.temp/interrupt-report.md
  
  恢复方法:
    重新运行任务时会检测到未完成任务，询问是否恢复。
```

**代码示例**:

```javascript
class EmergencyHandler {
  async handleUserStop() {
    // 1. 立即停止
    this.stopAllOperations();
    
    // 2. 保存状态
    const state = this.captureCurrentState();
    await this.saveEmergencyState(state);
    
    // 3. 生成报告
    await this.generateInterruptReport(state);
    
    // 4. 询问用户
    const choice = await this.askUserIntention();
    
    // 5. 执行选择
    switch(choice) {
      case 'K': await this.keepFiles(); break;
      case 'D': await this.deleteFiles(); break;
      case 'P': await this.pauseTask(); break;
    }
    
    // 6. 记录审计
    this.auditLog.push({
      event: 'emergency_stop',
      action: choice,
      timestamp: Date.now()
    });
    
    // 7. 输出消息
    this.displayStopMessage(state, choice);
  }
}
```

---

## 💾 情况2: 系统资源不足

**触发条件**:
- 内存不足: Available Memory < 100MB
- 磁盘满: Available Disk < 500MB
- CPU过载: CPU Usage > 95% 持续1分钟

**处理流程**:

```yaml
STEP 1: 检测资源状态
  检查:
    - 可用内存
    - 可用磁盘空间
    - CPU使用率
  
  记录当前值

STEP 2: 立即保存关键状态
  优先保存:
    - 当前STEP编号
    - 已生成文件列表
    - 用户确认记录
  
  最小化状态文件大小:
    - 压缩JSON
    - 删除详细日志 (只保留摘要)

STEP 3: 清理临时文件
  删除:
    - .temp/ 目录下的分段文件
    - 旧的状态快照
    - 临时分析文件
  
  释放空间: X MB

STEP 4: 降级操作
  IF 内存不足:
    - 减少并发操作
    - 分批处理大文件
    - 降低采样率
  
  IF 磁盘不足:
    - 压缩生成文件
    - 删除旧报告
    - 建议用户清理空间

STEP 5: 提示用户
  ⚠️ 系统资源不足
  
  问题: 可用内存仅剩 80MB
  
  已采取措施:
    ✅ 保存当前状态
    ✅ 清理临时文件 (释放 150MB)
    ✅ 降级为批处理模式
  
  建议:
    1. 关闭其他应用释放内存
    2. 清理磁盘空间
    3. 增加虚拟内存
  
  选项:
    [C] 继续执行 (降级模式)
    [P] 暂停任务
    [S] 停止任务

STEP 6: 等待资源恢复或用户决定
```

---

## 💥 情况3: 严重错误

**触发条件**:
- 未捕获的异常
- 工具调用严重失败
- 数据损坏
- 无法恢复的错误

**处理流程**:

```yaml
STEP 1: 捕获错误
  记录:
    - 错误类型
    - 错误消息
    - 完整堆栈
    - 发生位置 (STEP和代码行)

STEP 2: 保存错误现场
  位置: /reports/{模块名}/.temp/error-dump.json
  
  内容:
    {
      "error": {
        "type": "TypeError",
        "message": "Cannot read property 'xxx'",
        "stack": "...",
        "step": "STEP 9",
        "operation": "code_generation"
      },
      "state": { 当前完整状态 },
      "context": { 相关上下文 }
    }

STEP 3: 保存已完成工作
  即使出错，也保存:
    - 已生成的文件
    - 已完成的STEP结果
    - 审计日志

STEP 4: 生成详细错误报告
  位置: /reports/{模块名}/.temp/error-report.md
  
  内容:
    ## 严重错误报告
    
    错误时间: 2025-11-21 10:30:00
    错误类型: TypeError
    错误位置: STEP 9 - 代码生成
    
    错误详情:
      Cannot read property 'name' of undefined
      at generateCode (line 45)
    
    上下文:
      - 用户请求: "开发用户查询接口"
      - 当前操作: 生成 user-service.js
      - Profile: ndsk_core
    
    已完成工作:
      ✅ STEP 0-8
      ✅ 分析报告已生成
    
    未完成工作:
      ❌ STEP 9 代码生成失败
      ⏸️ STEP 10-22
    
    可能原因:
      1. Schema数据格式异常
      2. 模板引擎错误
      3. 变量未定义
    
    建议措施:
      1. 检查Schema数据
      2. 查看详细错误堆栈
      3. 联系技术支持

STEP 5: 尝试自动恢复 (如可能)
  IF 错误可恢复:
    - 重试当前操作 (最多3次)
    - 使用降级方案
    - 跳过当前STEP继续
  
  IF 无法恢复:
    - 终止流程
    - 提供人工支持信息

STEP 6: 通知用户
  🔴 严重错误发生
  
  错误: 代码生成过程中发生TypeError
  位置: STEP 9
  
  已保存:
    ✅ 已完成工作 (STEP 0-8)
    ✅ 错误现场快照
    ✅ 详细错误报告
  
  查看详情:
    报告: /reports/user-service/.temp/error-report.md
    错误快照: /reports/user-service/.temp/error-dump.json
  
  后续选项:
    [R] 重试 (Retry, 已重试 0/3 次)
    [S] 跳过此STEP继续 (Skip, ⚠️ 风险)
    [A] 终止任务 (Abort)
    [H] 人工支持 (Help)
```

---

## ⏱️ 情况4: 时间超限

**触发条件**:
- 单个STEP执行超过30分钟
- 总任务执行超过2小时
- 用户设定的时间限制

**处理流程**:

```yaml
STEP 1: 检测超时
  监控:
    - 每个STEP的执行时间
    - 总任务时间
  
  阈值:
    - STEP超时: 30分钟
    - 任务超时: 2小时

STEP 2: 保存当前进度
  自动保存状态 (即使未完成)

STEP 3: 询问用户
  ⚠️ 执行时间较长
  
  当前: STEP 5 (全面分析)
  已执行: 35分钟
  预计还需: 未知
  
  可能原因:
    - 项目规模较大 (1000+文件)
    - 分析复杂度高
    - 系统资源有限
  
  选项:
    [C] 继续等待 (Continue)
    [D] 分阶段处理 (Divide)
    [S] 停止任务 (Stop)
  
  建议: 选择 [D] 分阶段处理

STEP 4: 执行用户选择
  IF 选择 C (继续):
    - 继续当前操作
    - 增加超时时间 +30分钟
  
  IF 选择 D (分阶段):
    - 暂停当前STEP
    - 保存中间结果
    - 提示用户分批处理:
      "建议分为3个子任务:
       1. 分析核心模块 (10-15分钟)
       2. 分析工具模块 (10-15分钟)
       3. 生成报告 (5分钟)"
  
  IF 选择 S (停止):
    - 执行紧急停止流程
```

---

## 🔧 情况5: 工具不可用

**触发条件**:
- MongoDB MCP连接失败
- 文件系统错误
- 网络工具不可用
- 权限不足

**处理流程**:

```yaml
STEP 1: 识别工具问题
  工具: MongoDB MCP
  错误: Connection refused

STEP 2: 尝试自动恢复
  重试策略:
    - 重试次数: 3次
    - 重试间隔: 2秒, 5秒, 10秒
    - 指数退避

STEP 3: 提供降级方案
  IF MongoDB MCP不可用:
    选项1: 跳过数据库查询，使用假设数据
    选项2: 等待MCP恢复
    选项3: 手动提供Schema
  
  提示用户选择

STEP 4: 记录工具失败
  auditLog.push({
    event: 'tool_failure',
    tool: 'mcp_mongodb-chat_find',
    error: 'Connection refused',
    retries: 3,
    fallback: userChoice,
    timestamp: Date.now()
  });
```

---

## 💣 情况6: 数据丢失风险

**触发条件**:
- 状态文件损坏
- 生成的文件被意外删除
- 锁文件异常
- 并发冲突

**处理流程**:

```yaml
STEP 1: 检测数据异常
  检查:
    - 状态文件完整性
    - 生成文件是否存在
    - 锁文件状态

STEP 2: 立即停止写入
  - 停止所有文件操作
  - 防止覆盖数据

STEP 3: 尝试恢复
  IF 状态文件损坏:
    - 查找备份状态
    - 尝试修复JSON
    - 使用最近的有效状态
  
  IF 文件被删除:
    - 检查是否有备份
    - 查看Git历史
    - 提示用户恢复

STEP 4: 生成数据丢失报告
  🔴 检测到数据丢失风险
  
  问题: 状态文件损坏
  影响: 可能无法恢复任务
  
  尝试恢复:
    ✅ 找到5分钟前的备份
    ✅ 成功恢复到 STEP 12
  
  丢失内容:
    - STEP 13-14 的进度
    - 最近3分钟的工作
  
  建议:
    [R] 使用恢复的状态继续
    [N] 开始新任务
```

---

## 🔄 紧急恢复流程

**从紧急状态恢复**:

```yaml
恢复流程:

STEP 1: 检测紧急状态
  启动时检查:
    - emergency-state.json
    - interrupt-report.md
    - error-dump.json

STEP 2: 显示恢复提示
  🔄 检测到未完成的任务
  
  任务: 开发用户查询接口
  中断时间: 5分钟前
  进度: 64% (STEP 14/22)
  中断原因: 用户停止
  
  可恢复内容:
    ✅ 已生成代码 (2个文件)
    ✅ 已生成测试 (1个文件)
    ⏸️ 测试尚未确认
  
  选项:
    [R] 恢复任务 (Resume)
    [V] 查看详情 (View)
    [N] 开始新任务 (New)
    [D] 删除旧任务 (Delete)

STEP 3: 执行用户选择
  IF 选择 R (恢复):
    - 加载状态
    - 验证文件完整性
    - 从中断的STEP继续
  
  IF 选择 V (查看):
    - 显示详细报告
    - 显示已生成文件
    - 再次提供选项
  
  IF 选择 N (新任务):
    - 归档旧状态
    - 开始新任务
  
  IF 选择 D (删除):
    - 删除所有相关文件
    - 清理状态
```

---

## 📞 紧急联系机制

**当AI无法处理时**:

```yaml
提供人工支持:

显示消息:
  🆘 需要人工支持
  
  问题: 严重错误无法自动恢复
  错误码: E-STEP9-001
  
  已保存信息:
    - 错误报告: /reports/xxx/error-report.md
    - 错误快照: /reports/xxx/error-dump.json
    - 联系文件: /reports/xxx/support-request.md
  
  获取帮助:
    1. 查看错误报告了解详情
    2. 检查FAQ: guidelines/docs/FAQ.md
    3. 提交Issue: [GitHub地址]
    4. 联系邮箱: support@example.com
  
  临时措施:
    - 已保存所有已完成工作
    - 可以稍后恢复任务
    - 不会丢失数据

生成支持请求文件:
  位置: /reports/{模块名}/.temp/support-request.md
  
  内容:
    ## 支持请求
    
    错误码: E-STEP9-001
    时间: 2025-11-21 10:30:00
    任务: 开发用户查询接口
    
    错误描述:
      [详细描述]
    
    环境信息:
      - AI版本: v3.0
      - Profile: ndsk_core
      - 系统: Windows/macOS/Linux
    
    附件:
      - error-report.md
      - error-dump.json
      - 最后的状态文件
```

---

## 📊 紧急情况统计

**建议记录的指标**:

```yaml
统计指标:
  紧急停止次数: X次
  资源不足次数: Y次
  严重错误次数: Z次
  平均恢复时间: W分钟
  
恢复成功率:
  成功恢复: X%
  部分恢复: Y%
  无法恢复: Z%

常见原因TOP 5:
  1. 用户主动停止 (40%)
  2. 内存不足 (25%)
  3. 代码生成错误 (15%)
  4. 工具调用失败 (10%)
  5. 其他 (10%)
```

---

**最后更新**: 2025-11-21  
**状态**: ✅ 完整

