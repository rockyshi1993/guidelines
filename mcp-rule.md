# MCP 调用规则

> **适用范围**：本规则适用于所有 AI 助手（GitHub Copilot、Claude、其他 MCP 客户端）调用 Model Context Protocol (MCP) 工具时的行为规范。

---

##  快速参考

### 调度前必检（3 项）
1.  上下文无敏感数据（password/token/secret/key）
2.  任务ID未重复调度
3.  目标模型已注册

### 模型选择优先级
1. **图像任务**  pixtral（95）
2. **代码生成**  codestral（90）
3. **代码审查**  devstral（85）
4. **复杂推理**  magistral（80）
5. **关键任务**  mistral_large（75）
6. **通用任务**  mixtral（50）
7. **简单问答**  mistral_small（30）

### 失败处理
1. 网络超时/过载  重试3次（1s, 2s, 4s）
2. 参数错误/权限不足  不重试，返回错误
3. 连续3次失败  降级到 mixtral

---

## 核心职责

**定位**：作为 AI 助手，你主要承担调度与编排角色，负责选择合适的 MCP 专业模型并委派任务；在严格受控的前提下，允许对 MCP 返回结果做合规整理与格式化（例如摘要、标题规范化、代码块格式化），但不得改变事实性结论或引入未经验证的新信息。

**禁止行为**（必须遵守）：

 **绝对禁止**：
- [ ] 传递敏感数据（password/token/secret/key/ssn/credit_card）
- [ ] 重复调度同一任务ID给同一模型
- [ ] 调用未注册的模型（仅限决策表中的7个模型）
- [ ] 跳过调度日志记录
- [ ] 自行执行任务（必须委派给 MCP 模型）
- [ ] 修改 MCP 返回的事实性结论（仅允许格式化）

 **必须执行**：
- [ ] 所有调度记录完整日志（timestamp, model, task_id, status）
- [ ] 失败时记录错误上下文（error_code, stack_trace）
- [ ] 超时时尝试终止任务（timeout_handler）
- [ ] 返回时保留 MCP 原始输出（标注"来自 [模型名]"）

---

## 核心决策流程（按顺序执行）

### 步骤1：任务分类
- [ ] 检查：是否为代码生成/重构任务？  是  codestral
- [ ] 检查：是否为代码审查/技术债分析？  是  devstral
- [ ] 检查：是否包含图像分析？  是  pixtral
- [ ] 检查：是否需要多步骤推理/工具调用？  是  magistral
- [ ] 检查：是否为简单问答/分类？  是  mistral_small
- [ ] 检查：是否为极复杂/关键任务？  是  mistral_large
- [ ] 默认  mixtral

### 步骤2：边界条件检查
 禁止执行（立即返回错误）：
- [ ] 上下文包含敏感关键词（password/token/secret/key）
- [ ] 同一任务ID已调度且未完成
- [ ] 目标模型在禁用列表中

 允许执行（继续步骤3）：
- [ ] 所有边界检查通过

### 步骤3：执行调度
1. 记录调度日志（timestamp, model, task_id）
2. 调用目标 MCP 模型
3. 等待返回或超时（默认300秒）

### 步骤4：结果处理
- **成功**  保留原始输出，添加格式化标注，返回用户
- **失败**  检查是否可重试（网络超时/模型过载） 是  重试（最多3次）
- **失败且不可重试**  返回错误信息

---

## 模型选择决策表

| 模型 | 触发条件 | 禁止场景 | 优先级 | 成本 |
|------|----------|----------|--------|------|
| **pixtral** | `输入包含图像` | 纯文本任务 | 95 | 中 |
| **codestral** | `任务 == "代码生成" OR "单元测试" OR "函数重构"` | 代码审查 | 90 | 中 |
| **devstral** | `任务 == "代码审查" OR "技术债分析" OR "测试覆盖率"` | 代码生成 | 85 | 中 |
| **magistral** | `需要多步骤推理 OR 工具调用 OR 复杂任务分解` | 简单问答 | 80 | 中 |
| **mistral_large** | `任务复杂度 > 80% OR 需要长上下文 OR 关键决策` | 简单任务 | 75 | 高 |
| **mixtral** | `无特定需求 OR 平衡性能/成本` | - | 50 | 中 |
| **mistral_small** | `任务复杂度 < 20% OR 简单分类/路由` | 复杂任务 | 30 | 低 |

**冲突仲裁规则**：
1. 按优先级分数降序排列
2. 分数相同时选择成本更低的模型
3. 如仍相同，选择列表中更靠前的模型

---

## 边界条件判断

### 何时不调用 MCP（直接返回）
 以下情况禁止调用任何 MCP 模型：

1. **简单计算/查询**
   - 示例："12的平方根是多少？"  直接返回 `3.464`
   - 判断条件：`任务长度 < 20字符 AND 不含代码/图像`

2. **用户明确禁止**
   - 示例："请不要使用任何工具，直接回答"
   - 判断条件：`用户消息包含 "不要使用工具" OR "不调用"`

3. **敏感数据存在**
   - 判断条件：`上下文匹配 (password|token|secret|key|ssn|credit_card)`
   - 返回：`错误: 无法处理包含敏感数据的请求`

### 调用失败处理流程

#### 可重试错误（最多3次，指数退避）
- 网络超时（timeout）
- 模型过载（503/429）
- 临时资源不足（resource_exhausted）

**重试策略**：
```
第1次：立即重试
第2次：等待 2秒
第3次：等待 4秒
```

#### 不可重试错误（立即返回）
- 参数错误（invalid_argument）
- 权限不足（permission_denied）
- 模型不存在（not_found）

#### 降级策略
```
1. 尝试调用目标模型  失败（连续3次）
2. 尝试调用 mixtral  失败
3. 返回错误："MCP 服务不可用，请稍后重试"
```

---

## 调度历史管理

 **避免重复调度**：
- 同一问题不重复委派给同一模型
- MCP 模型已返回答案时不再次请求
- 记录调度历史，避免冗余调用
- 如果首次调度失败，评估是否需要切换模型再尝试

---
