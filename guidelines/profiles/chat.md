# chat é¡¹ç›®è§„èŒƒï¼ˆAI åŠ©æ‰‹ç”¨ï¼‰

## ğŸ“‘ ç›®å½•å¯¼èˆª

- [ğŸ“‹ è§„èŒƒç»§æ‰¿](#-è§„èŒƒç»§æ‰¿)
- [ğŸ“¦ é¡¹ç›®ä¿¡æ¯](#-é¡¹ç›®ä¿¡æ¯)
  - [è¿è¡Œæ—¶ç¯å¢ƒ](#è¿è¡Œæ—¶ç¯å¢ƒ)
  - [æ ¸å¿ƒä¾èµ–](#æ ¸å¿ƒä¾èµ–)
  - [å¼€å‘ä¾èµ–](#å¼€å‘ä¾èµ–)
- [ğŸš€ æœ¬åœ°å‘½ä»¤](#-æœ¬åœ°å‘½ä»¤)
  - [ä¾èµ–ç®¡ç†](#ä¾èµ–ç®¡ç†)
  - [å¼€å‘å‘½ä»¤](#å¼€å‘å‘½ä»¤)
  - [ç¼–è¯‘å’Œæ„å»º](#ç¼–è¯‘å’Œæ„å»º)
  - [æµ‹è¯•å‘½ä»¤](#æµ‹è¯•å‘½ä»¤)
  - [ç”Ÿäº§éƒ¨ç½²å‘½ä»¤](#ç”Ÿäº§éƒ¨ç½²å‘½ä»¤)
- [ğŸ“‚ ç›®å½•ç»“æ„](#-ç›®å½•ç»“æ„)
  - [æ ¸å¿ƒä»£ç ç»“æ„](#æ ¸å¿ƒä»£ç ç»“æ„)
  - [æ ¹ç›®å½•æ–‡ä»¶](#æ ¹ç›®å½•æ–‡ä»¶)
- [ğŸ”’ MCP é…ç½®](#-mcp-é…ç½®å¼ºåˆ¶)
  - [æ•°æ®åº“è®¿é—®é…ç½®](#æ•°æ®åº“è®¿é—®é…ç½®)
  - [æ“ä½œæƒé™](#æ“ä½œæƒé™)
  - [ä½¿ç”¨æµç¨‹](#ä½¿ç”¨æµç¨‹)
- [ğŸ“‹ ä¾‹å¤–ä¸è¦†ç›–](#-ä¾‹å¤–ä¸è¦†ç›–)
  - [ä»£ç é£æ ¼ä¾‹å¤–](#ä»£ç é£æ ¼ä¾‹å¤–)
  - [æ¡†æ¶ç‰¹å®šè§„èŒƒ](#æ¡†æ¶ç‰¹å®šè§„èŒƒ)
  - [TypeScript é…ç½®](#typescript-é…ç½®)
- [ğŸ—ï¸ é¡¹ç›®ç‰¹å®šè§„åˆ™](#ï¸-é¡¹ç›®ç‰¹å®šè§„åˆ™)
  - [1. å¼ºåˆ¶ä½¿ç”¨ä¸­é—´ä»¶](#1--å¼ºåˆ¶ä½¿ç”¨ä¸­é—´ä»¶å¿…é¡»éµå®ˆ)
    - [1.1 CRUD æ“ä½œå¿…é¡»ä½¿ç”¨ crudHelper](#11-crud-æ“ä½œå¿…é¡»ä½¿ç”¨-crudhelper)
    - [1.2 å“åº”å¿…é¡»ä½¿ç”¨ responseHelper](#12-å“åº”å¿…é¡»ä½¿ç”¨-responsehelper)
    - [1.3 æ¥å£é‰´æƒå¿…é¡»ä½¿ç”¨ userAuth](#13-æ¥å£é‰´æƒå¿…é¡»ä½¿ç”¨-userauth)
    - [1.4 è¯·æ±‚å‚æ•°æ ¡éªŒå¿…é¡»ä½¿ç”¨ validatorHelper](#14-è¯·æ±‚å‚æ•°æ ¡éªŒå¿…é¡»ä½¿ç”¨-validatorhelper)
    - [1.5 HTTP è¯·æ±‚å¿…é¡»ä½¿ç”¨ httpHelper](#15-http-è¯·æ±‚å¿…é¡»ä½¿ç”¨-httphelper)
  - [2. ä¸ä½¿ç”¨ Service å±‚](#2-ï¸-ä¸ä½¿ç”¨-service-å±‚æ¶æ„è§„åˆ™)
    - [2.1 ä¸šåŠ¡é€»è¾‘å†™åœ¨ Controller](#21-ä¸šåŠ¡é€»è¾‘å†™åœ¨-controller)
    - [2.2 é€šç”¨å·¥å…·å‡½æ•°å°è£…è§„åˆ™](#22-é€šç”¨å·¥å…·å‡½æ•°å°è£…è§„åˆ™)
    - [2.3 å†å² Service ä»£ç å¤„ç†](#23-å†å²-service-ä»£ç å¤„ç†)
  - [3. æœåŠ¡å™¨ä¹‹é—´è·¯ç”±é€šä¿¡æ— éœ€é‰´æƒ](#3-æœåŠ¡å™¨ä¹‹é—´è·¯ç”±é€šä¿¡æ— éœ€é‰´æƒ)
  - [4. æ•°æ®åº“æ“ä½œè§„èŒƒ](#4-æ•°æ®åº“æ“ä½œè§„èŒƒ)
  - [5. å›½é™…åŒ–å“åº”è§„èŒƒ](#5--å›½é™…åŒ–å“åº”è§„èŒƒå¿…é¡»éµå®ˆ)
- [ğŸ¯ æ¶æ„å±‚æ¬¡è§„åˆ™](#-æ¶æ„å±‚æ¬¡è§„åˆ™)
  - [ä»£ç åˆ†å±‚](#ä»£ç åˆ†å±‚æœ¬é¡¹ç›®ä¸ä½¿ç”¨-service-å±‚)
  - [èŒè´£åˆ’åˆ†](#èŒè´£åˆ’åˆ†)
  - [ä»£ç ç¤ºä¾‹](#ä»£ç ç¤ºä¾‹)
- [âœ… å¿«é€Ÿæ£€æŸ¥æ¸…å•](#-å¿«é€Ÿæ£€æŸ¥æ¸…å•)
  - [ä»£ç é£æ ¼æ£€æŸ¥](#ä»£ç é£æ ¼æ£€æŸ¥)
  - [ä¸­é—´ä»¶ä½¿ç”¨æ£€æŸ¥](#ä¸­é—´ä»¶ä½¿ç”¨æ£€æŸ¥å¼ºåˆ¶)
  - [æ•°æ®åº“æ“ä½œæ£€æŸ¥](#æ•°æ®åº“æ“ä½œæ£€æŸ¥å¼ºåˆ¶)
  - [æ¶æ„åˆ†å±‚æ£€æŸ¥](#æ¶æ„åˆ†å±‚æ£€æŸ¥ä¸ä½¿ç”¨-service-å±‚)
  - [è·¯ç”±é…ç½®æ£€æŸ¥](#è·¯ç”±é…ç½®æ£€æŸ¥)
  - [TypeScript ç±»å‹æ£€æŸ¥](#typescript-ç±»å‹æ£€æŸ¥)
  - [é”™è¯¯å¤„ç†æ£€æŸ¥](#é”™è¯¯å¤„ç†æ£€æŸ¥)
  - [å›½é™…åŒ–æ£€æŸ¥](#å›½é™…åŒ–æ£€æŸ¥)

---

## ğŸ“‹ è§„èŒƒç»§æ‰¿
æœ¬é¡¹ç›®éµå¾ª `D:/OneDrive/Project/common/guidelines/guidelines/v3.md` é€šç”¨è§„èŒƒã€‚ä»¥ä¸‹ä»…åˆ—å‡ºé¡¹ç›®ç‰¹å®šé…ç½®å’Œä¾‹å¤–ã€‚

---

## ğŸ“¦ é¡¹ç›®ä¿¡æ¯

- **é¡¹ç›®åç§°**: chat
- **é¡¹ç›®ç±»å‹**: Egg.js ä¼ä¸šçº§åç«¯æœåŠ¡ï¼ˆTypeScriptï¼‰
- **æ¨¡å—ç³»ç»Ÿ**: CommonJSï¼ˆrequire/exportsï¼‰
- **é¡¹ç›®å®šä½**: AI å¯¹è¯ç³»ç»Ÿ + è¡Œç¨‹ç®¡ç† + è¥é”€æ´»åŠ¨å¹³å°
- **å½“å‰ç‰ˆæœ¬**: v1.0.0
- **æ¡†æ¶ç‰ˆæœ¬**: Egg.js 3.17.5

### è¿è¡Œæ—¶ç¯å¢ƒ
- **Node.js ç‰ˆæœ¬**: â‰¥16.0.0
- **æ“ä½œç³»ç»Ÿ**: Linuxï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- **æ•°æ®åº“**: 
  - âœ… MongoDBï¼ˆä¸»æ•°æ®åº“ï¼Œé€šè¿‡ egg-mongooseï¼‰
  - âœ… Redisï¼ˆç¼“å­˜å’Œä¼šè¯ï¼Œé€šè¿‡ egg-redisï¼‰
  - âœ… ShareDBï¼ˆå®æ—¶åä½œï¼ŒMongoDB å­˜å‚¨ï¼‰
- **éƒ¨ç½²æ–¹å¼**: Docker + PM2

### æ ¸å¿ƒä¾èµ–
- **Web æ¡†æ¶**: 
  - `egg@^3.17.5` - Egg.js æ ¸å¿ƒæ¡†æ¶
  - `egg-scripts@2` - ç”Ÿäº§ç¯å¢ƒå¯åŠ¨è„šæœ¬
- **æ•°æ®åº“**: 
  - `egg-mongoose@^4.0.1` - MongoDB ODM
  - `egg-redis@^2.6.0` - Redis å®¢æˆ·ç«¯
  - `sharedb@^5.1.1` - å®æ—¶åä½œå¼•æ“
  - `sharedb-mongo@^5.0.0` - ShareDB MongoDB é€‚é…å™¨
- **ä¸­é—´ä»¶ä¸å·¥å…·**:
  - `egg-jwt@^3.1.7` - JWT è®¤è¯
  - `egg-validate@^2.0.2` - å‚æ•°æ ¡éªŒ
  - `egg-cors@^3.0.1` - è·¨åŸŸæ”¯æŒ
  - `egg-websocket-plugin@^3.0.0-beta.0` - WebSocket æ”¯æŒ
  - `joi@^18.0.1` - é«˜çº§å‚æ•°æ ¡éªŒ
- **AI é›†æˆ**:
  - `openai@^4.71.1` - OpenAI API å®¢æˆ·ç«¯
- **å…¶ä»–å·¥å…·**:
  - `axios@^1.7.3` - HTTP å®¢æˆ·ç«¯
  - `moment@^2.30.1` - æ—¥æœŸå¤„ç†
  - `uuid@^9.0.1` - UUID ç”Ÿæˆ
  - `exceljs@^4.4.0` - Excel å¤„ç†

### å¼€å‘ä¾èµ–
- `egg-bin@^6.8.1` - å¼€å‘å’Œæµ‹è¯•å·¥å…·
- `eslint@8` - ä»£ç è´¨é‡æ£€æŸ¥
- `eslint-config-egg@13` - Egg.js ESLint é…ç½®

---

## ğŸš€ æœ¬åœ°å‘½ä»¤

### ä¾èµ–ç®¡ç†
```bash
# å®‰è£…ä¾èµ–
npm install
```

### å¼€å‘å‘½ä»¤
```bash
# æœ¬åœ°å¼€å‘ï¼ˆçƒ­é‡è½½ï¼‰
npm run dev

# è®¿é—®åœ°å€
# http://localhost:9001/
```

### ç¼–è¯‘å’Œæ„å»º
```bash
# TypeScript ç¼–è¯‘
npm run tsc

# æ¸…ç†ç¼–è¯‘è¾“å‡º
npm run clean
```

### æµ‹è¯•å‘½ä»¤
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm test

# ä»…è¿è¡Œå•å…ƒæµ‹è¯•
npm run test:local

# ä»£ç è¦†ç›–ç‡
npm run cov

# ä»£ç é£æ ¼æ£€æŸ¥
npm run lint
```

### ç”Ÿäº§éƒ¨ç½²å‘½ä»¤
```bash
# å¯åŠ¨æœåŠ¡ï¼ˆå®ˆæŠ¤è¿›ç¨‹ï¼‰
npm start

# åœæ­¢æœåŠ¡
npm stop

# ä¸åŒç¯å¢ƒå¯åŠ¨
npm run sit         # SIT ç¯å¢ƒï¼ˆ4 workersï¼‰
npm run aita-uat    # UAT ç¯å¢ƒï¼ˆ4 workersï¼‰
npm run aita-prod   # ç”Ÿäº§ç¯å¢ƒï¼ˆ4 workersï¼‰

# PM2 ç®¡ç†ï¼ˆæ¨èï¼‰
npm run pm2-sit     # PM2 å¯åŠ¨ SIT
npm run pm2-stop-sit # PM2 åœæ­¢
```

---

## ğŸ“‚ ç›®å½•ç»“æ„

### æ ¸å¿ƒä»£ç ç»“æ„
```
app/
â”œâ”€â”€ controller/              # æ§åˆ¶å™¨å±‚
â”‚   â”œâ”€â”€ admin/              # ç®¡ç†åå°æ§åˆ¶å™¨ï¼ˆ60+ ä¸ªï¼‰
â”‚   â”œâ”€â”€ home/               # å‰å°ç”¨æˆ·æ§åˆ¶å™¨ï¼ˆ60+ ä¸ªï¼‰
â”‚   â”œâ”€â”€ internal/           # å†…éƒ¨æœåŠ¡æ¥å£
â”‚   â”œâ”€â”€ open/               # å¼€æ”¾ API
â”‚   â”œâ”€â”€ schedule/           # å®šæ—¶ä»»åŠ¡æ§åˆ¶å™¨
â”‚   â””â”€â”€ ws/                 # WebSocket æ§åˆ¶å™¨
â”‚
â”œâ”€â”€ service/                # âš ï¸ å†å²é—ç•™ï¼Œæ–°ä»£ç ä¸ä½¿ç”¨
â”‚   â””â”€â”€ ...                # æ—§ä»£ç ä¿ç•™ï¼Œä¸å†æ–°å¢
â”‚
â”œâ”€â”€ model/                  # æ•°æ®æ¨¡å‹å±‚ï¼ˆMongoose Schemasï¼‰
â”‚   â”œâ”€â”€ conversation.ts     # å¯¹è¯æ¨¡å‹
â”‚   â”œâ”€â”€ message.ts         # æ¶ˆæ¯æ¨¡å‹
â”‚   â”œâ”€â”€ trip.ts            # è¡Œç¨‹æ¨¡å‹
â”‚   â””â”€â”€ ...                # 60+ æ•°æ®æ¨¡å‹
â”‚
â”œâ”€â”€ middleware/             # ä¸­é—´ä»¶å±‚
â”‚   â”œâ”€â”€ crudHelper.ts      # CRUD å·¥å…·æ³¨å…¥ â­
â”‚   â”œâ”€â”€ responseHelper.ts  # ç»Ÿä¸€å“åº”å¤„ç† â­
â”‚   â”œâ”€â”€ userAuth.ts        # ç”¨æˆ·è®¤è¯ â­
â”‚   â”œâ”€â”€ validatorHelper.ts # å‚æ•°æ ¡éªŒ â­
â”‚   â”œâ”€â”€ httpHelper.ts      # HTTP è°ƒç”¨å·¥å…·
â”‚   â”œâ”€â”€ internalAuth.ts    # å†…éƒ¨æœåŠ¡è®¤è¯
â”‚   â””â”€â”€ exceptions.ts      # å¼‚å¸¸å¤„ç†
â”‚
â”œâ”€â”€ routes/                 # è·¯ç”±é…ç½®
â”‚   â”œâ”€â”€ admin/             # ç®¡ç†åå°è·¯ç”±
â”‚   â”œâ”€â”€ home/              # å‰å°è·¯ç”±
â”‚   â”œâ”€â”€ internal/          # å†…éƒ¨è·¯ç”±
â”‚   â”œâ”€â”€ open/              # å¼€æ”¾è·¯ç”±
â”‚   â”œâ”€â”€ schedule/          # å®šæ—¶ä»»åŠ¡è·¯ç”±
â”‚   â””â”€â”€ ws/                # WebSocket è·¯ç”±
â”‚
â”œâ”€â”€ validator/              # å‚æ•°æ ¡éªŒå™¨ï¼ˆJoi Schemasï¼‰
â”‚   â”œâ”€â”€ home/              # å‰å°æ ¡éªŒå™¨
â”‚   â””â”€â”€ admin/             # åå°æ ¡éªŒå™¨
â”‚
â”œâ”€â”€ utils/                  # å·¥å…·å‡½æ•°ï¼ˆâ­ é‡è¦ï¼‰
â”‚   â”œâ”€â”€ crud.ts            # CRUD é€šç”¨æ“ä½œ
â”‚   â”œâ”€â”€ repository.ts      # æ•°æ®ä»“å‚¨å·¥å…·
â”‚   â””â”€â”€ ...                # ä¸šåŠ¡å·¥å…·å‡½æ•°ï¼ˆè°ƒç”¨æ¬¡æ•° â‰¥2 æ—¶å°è£…ï¼‰
â”‚
â”œâ”€â”€ schedule/               # å®šæ—¶ä»»åŠ¡
â”œâ”€â”€ hooks/                  # ç”Ÿå‘½å‘¨æœŸé’©å­
â”‚   â”œâ”€â”€ app/               # åº”ç”¨çº§é’©å­
â”‚   â””â”€â”€ agent/             # Agent çº§é’©å­
â”‚
â””â”€â”€ public/                 # é™æ€èµ„æº

config/                     # é…ç½®æ–‡ä»¶
â”œâ”€â”€ config.default.ts       # é»˜è®¤é…ç½®
â”œâ”€â”€ config.local.ts         # æœ¬åœ°å¼€å‘é…ç½®
â”œâ”€â”€ config.sit.ts          # SIT ç¯å¢ƒé…ç½®
â”œâ”€â”€ config.uat.ts          # UAT ç¯å¢ƒé…ç½®
â””â”€â”€ config.prod.ts         # ç”Ÿäº§ç¯å¢ƒé…ç½®

typings/                    # TypeScript ç±»å‹å®šä¹‰
â”œâ”€â”€ enum/                   # æšä¸¾ç±»å‹
â”œâ”€â”€ interface/              # æ¥å£å®šä¹‰
â””â”€â”€ app/                    # Egg åº”ç”¨ç±»å‹æ‰©å±•
```

### æ ¹ç›®å½•æ–‡ä»¶
```
package.json                # é¡¹ç›®é…ç½®
tsconfig.json              # TypeScript é…ç½®
.eslintrc                  # ESLint é…ç½®ï¼ˆegg-config-eggï¼‰
.gitignore                 # Git å¿½ç•¥é…ç½®
.gitlab-ci.yml             # GitLab CI/CD é…ç½®
app.ts                     # åº”ç”¨å¯åŠ¨å…¥å£
agent.ts                   # Agent å¯åŠ¨å…¥å£
README.md                  # é¡¹ç›®è¯´æ˜
CHANGELOG.md               # å˜æ›´æ—¥å¿—
```

---

## ğŸ”’ MCP é…ç½®ï¼ˆğŸ”´ å¼ºåˆ¶ï¼‰

### æ•°æ®åº“è®¿é—®é…ç½®
- **æ•°æ®åº“ç±»å‹**: MongoDB
- **è¿æ¥å­—ç¬¦ä¸²**: `mongodb://root:SYY54YsaXuBHndSe@47.84.66.151:28017/?directConnection=true`
- **æ•°æ®åº“åç§°**: `trip`ï¼ˆé€šè¿‡ Nacos é…ç½®ï¼‰
- **å…è®¸çš„ MCP æœåŠ¡å™¨**: `mongodb-chat`

### æ“ä½œæƒé™
- âœ… **å…è®¸ï¼šè¯»å–æ“ä½œ**
  - find, findOne, count, aggregate
  - ç”¨äºæŸ¥è¯¢æ•°æ®åº“å®é™…ç»“æ„
  - ç”¨äºåˆ†ææ•°æ®å’Œè°ƒè¯•

- âš ï¸ **è°¨æ…ï¼šå†™å…¥æ“ä½œï¼ˆå¿…é¡»ç”¨æˆ·ç¡®è®¤ï¼‰**
  - insertOne, insertMany
  - updateOne, updateMany
  - replaceOne
  - **è§„åˆ™**: é™¤äº†æŸ¥è¯¢ä¹‹å¤–ï¼Œæ‰€æœ‰æ•°æ®åº“æ“ä½œå¿…é¡»ç”¨æˆ·ç¡®è®¤åæ‰èƒ½æ‰§è¡Œ

- ğŸ”´ **ç¦æ­¢ï¼šåˆ é™¤æ“ä½œï¼ˆé™¤éæ˜ç¡®æˆæƒï¼‰**
  - deleteOne, deleteMany
  - drop
  - **è§„åˆ™**: åˆ é™¤æ“ä½œéœ€è¦æ˜ç¡®è¯´æ˜åŸå› å¹¶è·å¾—ç”¨æˆ·åŒæ„

### ä½¿ç”¨æµç¨‹
1. **ä¿®å¤ä»£ç /å†™éœ€æ±‚æ¶‰åŠæ•°æ®åº“æ—¶**:
   - âœ… å¿…é¡»å…ˆä½¿ç”¨ MCP æŸ¥è¯¢æ•°æ®åº“å®é™…ç»“æ„
   - âœ… åŸºäºçœŸå® Schema ç¼–å†™ä»£ç 
   - âœ… é¿å…å­—æ®µå/ç±»å‹é”™è¯¯

2. **æŸ¥è¯¢åçš„æ“ä½œ**:
   - âœ… å±•ç¤ºæŸ¥è¯¢ç»“æœç»™ç”¨æˆ·
   - âš ï¸ å†™å…¥æ“ä½œå¿…é¡»ç­‰å¾…ç”¨æˆ·ç¡®è®¤
   - ğŸ”´ åˆ é™¤æ“ä½œå¿…é¡»æ˜ç¡®åŸå› å’Œå½±å“

---

## ğŸ“‹ ä¾‹å¤–ä¸è¦†ç›–

### ä»£ç é£æ ¼ä¾‹å¤–
ç›¸å¯¹é€šç”¨è§„èŒƒï¼ˆv3.md ä»£ç è§„èŒƒï¼‰çš„å·®å¼‚ï¼š
- **æ¨¡å—ç³»ç»Ÿ**: CommonJSï¼ˆé€šç”¨è§„èŒƒé»˜è®¤ï¼šESMï¼‰
- **ç¼©è¿›**: 4 ç©ºæ ¼ï¼ˆé€šç”¨è§„èŒƒé»˜è®¤ï¼š2 ç©ºæ ¼ï¼‰
- **å¼•å·**: å•å¼•å·ï¼ˆä¸é€šç”¨è§„èŒƒä¸€è‡´ï¼‰
- **åˆ†å·**: å¿…é¡»ï¼ˆä¸é€šç”¨è§„èŒƒä¸€è‡´ï¼‰

### æ¡†æ¶ç‰¹å®šè§„èŒƒ
- **æ–‡ä»¶å‘½å**: PascalCaseï¼ˆController/Service/Modelï¼‰
  - ç¤ºä¾‹ï¼š`ConversationController.ts`, `TripService.ts`
- **è·¯ç”±å‘½å**: kebab-case
  - ç¤ºä¾‹ï¼š`/home/conversation/list`
- **æšä¸¾å‘½å**: PascalCase + Enum åç¼€
  - ç¤ºä¾‹ï¼š`StatusEnum`, `MessageRoleEnum`

### TypeScript é…ç½®
- **target**: ES2019
- **module**: CommonJS
- **strict**: true
- **noImplicitAny**: falseï¼ˆå…è®¸éšå¼ anyï¼‰
- **è·¯å¾„åˆ«å**:
  ```typescript
  "paths": {
    "enum/*": ["typings/enum/*"],
    "interface/*": ["typings/interface/*"],
    "config/*": ["config/*"],
    "utils/*": ["app/utils/*"],
    "validator/*": ["app/validator/*"]
  }
  ```

---

## ğŸ—ï¸ é¡¹ç›®ç‰¹å®šè§„åˆ™

### 1. ğŸ”´ å¼ºåˆ¶ä½¿ç”¨ä¸­é—´ä»¶ï¼ˆå¿…é¡»éµå®ˆï¼‰

#### 1.1 CRUD æ“ä½œå¿…é¡»ä½¿ç”¨ crudHelper
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ ctx.utilsCrud
const { paginate, createOne, updateOne, deleteOne } = (ctx as any).utilsCrud;

// åˆ†é¡µæŸ¥è¯¢
const result = await paginate(ctx.model.Conversation, 
  { user_id: userId, del_flag: 0 },
  { page: 1, pageSize: 10, sort: { created_at: -1 } }
);

// åˆ›å»º
const doc = await createOne(ctx.model.Conversation, { 
  user_id: userId,
  title: 'æ–°å¯¹è¯'
});

// æ›´æ–°
const updated = await updateOne(ctx.model.Conversation,
  { _id: id },
  { $set: { title: 'æ›´æ–°æ ‡é¢˜' } }
);

// åˆ é™¤ï¼ˆè½¯åˆ é™¤ï¼‰
const deleted = await deleteOne(ctx.model.Conversation,
  { _id: id }
);
```

**âŒ ç¦æ­¢ç›´æ¥ä½¿ç”¨ Mongoose Model**:
```typescript
// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨ Model
const result = await ctx.model.Conversation.find({}).limit(10);
```

#### 1.2 å“åº”å¿…é¡»ä½¿ç”¨ responseHelper
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ç»Ÿä¸€å“åº”
export default class ConversationController extends Controller {
  async list() {
    const { ctx } = this;
    try {
      const data = await ctx.service.ai.conversationService.list();
      return ctx.success(data, 'æŸ¥è¯¢æˆåŠŸ');
    } catch (err) {
      return ctx.error('[ConversationController]', err, 'æŸ¥è¯¢å¤±è´¥');
    }
  }

  async create() {
    const { ctx } = this;
    // ä¸šåŠ¡æ ¡éªŒå¤±è´¥
    if (!ctx.request.body.title) {
      throw ctx.fail('æ ‡é¢˜ä¸èƒ½ä¸ºç©º', 400);
    }
    // ... åˆ›å»ºé€»è¾‘
    return ctx.success(result, 'åˆ›å»ºæˆåŠŸ');
  }
}
```

**ç»Ÿä¸€å“åº”æ ¼å¼**:
```typescript
// æˆåŠŸå“åº”
ctx.success(data, 'ok')
// => { code: 0, message: 'ok', data: {...} }

// ä¸šåŠ¡å¤±è´¥
throw ctx.fail('å‚æ•°é”™è¯¯', 400)
// => { code: 400, message: 'å‚æ•°é”™è¯¯', data: null }

// ç³»ç»Ÿé”™è¯¯
ctx.error('[Tag]', err, 'æ“ä½œå¤±è´¥')
// => { code: 500, message: 'æ“ä½œå¤±è´¥', data: { error: '...' } }
```

#### 1.3 æ¥å£é‰´æƒå¿…é¡»ä½¿ç”¨ userAuth
```typescript
// routes/home/conversation.ts
export default (app: Application, group: RouterGroup) => {
  const ctrl = app.controller.home.conversationController;
  
  const sub = group.group({ prefix: '/conversation' });
  
  // âœ… æ­£ç¡®ï¼šä½¿ç”¨ userAuth ä¸­é—´ä»¶
  // basic çº§åˆ«ï¼šJWT + å•ç‚¹ç™»å½•æ ¡éªŒ
  sub.get('/list', 
    app.middleware.userAuth({ level: 'basic' }), 
    ctrl.list
  );
  
  // strict çº§åˆ«ï¼šJWT + å•ç‚¹ç™»å½• + ç™»å½•æœ‰æ•ˆæ€§æ ¡éªŒ
  sub.post('/create',
    app.middleware.userAuth({ level: 'strict' }),
    ctrl.create
  );
  
  // public çº§åˆ«ï¼šæ— éœ€é‰´æƒ
  sub.get('/public',
    ctrl.public
  );
};
```

**é‰´æƒç­‰çº§è¯´æ˜**:
- `public`: æ— éœ€é‰´æƒï¼ˆç›´æ¥æ”¾è¡Œï¼‰
- `basic`: JWT + å•ç‚¹ç™»å½•æ ¡éªŒï¼ˆé»˜è®¤ï¼‰
- `strict`: JWT + å•ç‚¹ç™»å½• + ç™»å½•æœ‰æ•ˆæ€§/é£æ§æ ¡éªŒ

#### 1.4 è¯·æ±‚å‚æ•°æ ¡éªŒå¿…é¡»ä½¿ç”¨ validatorHelper
```typescript
// validator/home/conversation_validator.ts
export default class ConversationValidator {
  private ctx: Context;

  constructor(ctx: Context) {
    this.ctx = ctx;
  }

  async index() {
    const schema = (this.ctx as any).Joi.object({
      page: (this.ctx as any).Joi.number().integer().min(1).default(1),
      pageSize: (this.ctx as any).Joi.number().integer().min(1).max(100).default(10),
      keyword: (this.ctx as any).Joi.string().allow('', null),
    });
    return (this.ctx as any).validateJoi(schema, 'query');
  }

  async create() {
    const schema = (this.ctx as any).Joi.object({
      title: (this.ctx as any).Joi.string().required(),
      user_id: (this.ctx as any).Joi.string().required(),
    });
    return (this.ctx as any).validateJoi(schema, 'body');
  }
}

// controller/home/ConversationController.ts
export default class ConversationController extends Controller {
  private readonly validator: ConversationValidator;

  constructor(ctx: any) {
    super(ctx);
    this.validator = new ConversationValidator(ctx);
  }

  async create() {
    const { ctx } = this;
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨ validator æ ¡éªŒ
    await this.validator.create();
    
    // æ ¡éªŒé€šè¿‡åçš„æ•°æ®å·²è‡ªåŠ¨å½’ä¸€åŒ–
    const { title, user_id } = ctx.request.body;
    
    // ... ä¸šåŠ¡é€»è¾‘
  }
}
```

#### 1.5 HTTP è¯·æ±‚å¿…é¡»ä½¿ç”¨ httpHelper

**æ‰€æœ‰å¯¹å¤–éƒ¨æœåŠ¡çš„ HTTP è¯·æ±‚å¿…é¡»ä½¿ç”¨ `ctx.http` å·¥å…·**ï¼Œç¦æ­¢ç›´æ¥ä½¿ç”¨ axios æˆ–å…¶ä»– HTTP åº“ã€‚

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ ctx.http
export default class ThirdPartyController extends Controller {
  async callExternalAPI() {
    const { ctx } = this;
    
    try {
      // åŸºæœ¬ GET è¯·æ±‚
      const result1 = await ctx.http.get(
        '[ThirdParty]',
        'https://api.example.com/users'
      );
      
      // POST è¯·æ±‚ï¼ˆå¸¦å‚æ•°ï¼‰
      const result2 = await ctx.http.post(
        '[ThirdParty]',
        'https://api.example.com/orders',
        {
          body: JSON.stringify({
            userId: ctx.state.user._id,
            items: [{ id: 1, qty: 2 }]
          })
        }
      );
      
      // å¸¦å®Œæ•´é…ç½®çš„è¯·æ±‚
      const result3 = await ctx.http.fetchJSON(
        '[ThirdParty]',
        'https://api.example.com/data',
        {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ query: 'test' }),
          timeoutMs: 10000,        // è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ 15000msï¼‰
          retries: 2,              // é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ 1ï¼‰
          backoff: {               // é€€é¿ç­–ç•¥
            baseMs: 300,
            factor: 2,
            jitter: true
          },
          expectedStatuses: [200, 201],  // æœŸæœ›çš„æˆåŠŸçŠ¶æ€ç 
          map4xxToFail: true,      // 4xx æ˜ å°„ä¸ºä¸šåŠ¡é”™è¯¯ï¼ˆctx.failï¼‰
          idempotencyKey: uuid(),  // å¹‚ç­‰æ€§é”®ï¼ˆç”¨äºå®‰å…¨é‡è¯•ï¼‰
          maxResponseBytes: 1024 * 1024,  // å“åº”å¤§å°é™åˆ¶ï¼ˆ1MBï¼‰
          redactHeaders: ['authorization', 'cookie']  // æ—¥å¿—è„±æ•å¤´
        }
      );
      
      return ctx.success(result3);
    } catch (err) {
      return ctx.error('[ThirdParty]', err, 'å¤–éƒ¨æœåŠ¡è°ƒç”¨å¤±è´¥');
    }
  }
}
```

**ctx.http API è¯´æ˜**:

```typescript
// GET è¯·æ±‚ï¼ˆå¿«æ·æ–¹æ³•ï¼‰
ctx.http.get(tag: string, url: string, init?: RequestInit)

// POST è¯·æ±‚ï¼ˆå¿«æ·æ–¹æ³•ï¼‰
ctx.http.post(tag: string, url: string, init?: RequestInit)

// å®Œæ•´è¯·æ±‚æ–¹æ³•
ctx.http.fetchJSON(tag: string, url: string, init?: {
  // åŸºæœ¬ fetch é€‰é¡¹
  method?: string;
  headers?: Record<string, string>;
  body?: any;
  
  // httpHelper æ‰©å±•é€‰é¡¹
  timeoutMs?: number;           // è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ 15000msï¼‰
  retries?: number;             // é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ 1ï¼‰
  backoff?: {                   // é€€é¿ç­–ç•¥
    baseMs?: number;            // åŸºç¡€å»¶è¿Ÿï¼ˆé»˜è®¤ 300msï¼‰
    factor?: number;            // å¢é•¿å› å­ï¼ˆé»˜è®¤ 2ï¼‰
    jitter?: boolean;           // éšæœºæŠ–åŠ¨ï¼ˆé»˜è®¤ trueï¼‰
  };
  parseJson?: boolean | 'auto'; // æ˜¯å¦è§£æ JSONï¼ˆé»˜è®¤ 'auto'ï¼‰
  expectedStatuses?: number[];  // é¢å¤–çš„æˆåŠŸçŠ¶æ€ç 
  map4xxToFail?: boolean;       // 4xx æ˜ å°„ä¸ºä¸šåŠ¡é”™è¯¯ï¼ˆé»˜è®¤ trueï¼‰
  idempotencyKey?: string;      // å¹‚ç­‰æ€§é”®ï¼ˆæ·»åŠ åˆ°è¯·æ±‚å¤´ï¼‰
  maxResponseBytes?: number;    // å“åº”å¤§å°é™åˆ¶ï¼ˆ0 = ä¸é™åˆ¶ï¼‰
  redactHeaders?: string[];     // æ—¥å¿—è„±æ•å¤´ï¼ˆé»˜è®¤ ['authorization', 'cookie']ï¼‰
})
```

**é‡è¦ç‰¹æ€§**:

1. **è‡ªåŠ¨é‡è¯•**: 5xx é”™è¯¯è‡ªåŠ¨é‡è¯•ï¼Œ4xx é”™è¯¯ä¸é‡è¯•
2. **é€€é¿ç­–ç•¥**: æŒ‡æ•°é€€é¿ + éšæœºæŠ–åŠ¨ï¼Œé¿å…é›ªå´©
3. **è¶…æ—¶æ§åˆ¶**: æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹è¶…æ—¶ï¼Œé¿å…é˜»å¡
4. **è¿½è¸ª ID**: è‡ªåŠ¨ä¼ é€’ `x-trace-id`ï¼Œä¾¿äºé“¾è·¯è¿½è¸ª
5. **é”™è¯¯åˆ†çº§**:
   - 4xx: æ˜ å°„ä¸º `ctx.fail()` ä¸šåŠ¡é”™è¯¯ï¼ˆä¸é‡è¯•ï¼‰
   - 5xx: æŠ›å‡ºç³»ç»Ÿé”™è¯¯ï¼ˆå¯é‡è¯•ï¼‰
6. **æ—¥å¿—è„±æ•**: è‡ªåŠ¨è„±æ•æ•æ„Ÿè¯·æ±‚å¤´ï¼ˆauthorization, cookieï¼‰
7. **å¹‚ç­‰æ€§**: æ”¯æŒå¹‚ç­‰æ€§é”®ï¼Œç¡®ä¿é‡è¯•å®‰å…¨

**é…ç½®é¡¹**ï¼ˆ`config/config.default.ts`ï¼‰:

```typescript
config.custom = {
  http: {
    timeoutMs: 15000,        // å…¨å±€é»˜è®¤è¶…æ—¶
    retries: 1,              // å…¨å±€é»˜è®¤é‡è¯•æ¬¡æ•°
    defaultHeaders: {        // å…¨å±€é»˜è®¤è¯·æ±‚å¤´
      'Content-Type': 'application/json'
    },
    backoff: {               // å…¨å±€é»˜è®¤é€€é¿ç­–ç•¥
      baseMs: 300,
      factor: 2,
      jitter: true
    }
  }
};
```

**âŒ ç¦æ­¢ç›´æ¥ä½¿ç”¨ axios æˆ– fetch**:

```typescript
// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨ axios
import axios from 'axios';
const result = await axios.get('https://api.example.com/data');

// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨ fetch
const response = await fetch('https://api.example.com/data');
const result = await response.json();

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ ctx.http
const result = await ctx.http.get('[Tag]', 'https://api.example.com/data');
```

**é”™è¯¯å¤„ç†ç¤ºä¾‹**:

```typescript
async callAPI() {
  const { ctx } = this;
  
  try {
    const result = await ctx.http.post(
      '[Payment]',
      'https://payment.example.com/charge',
      {
        body: JSON.stringify({ amount: 100 }),
        timeoutMs: 5000,
        retries: 2,
        map4xxToFail: true  // 4xx ä¼šæŠ›å‡º ctx.fail é”™è¯¯
      }
    );
    
    return ctx.success(result);
  } catch (err) {
    // å¦‚æœæ˜¯ 4xx é”™è¯¯ï¼ˆmap4xxToFail=trueï¼‰ï¼Œerr å·²ç»æ˜¯ { code: 4xx, message }
    // ç›´æ¥æŠ›å‡ºå³å¯
    if (err.code && err.code >= 400 && err.code < 500) {
      throw err;  // ctx.fail é”™è¯¯ç›´æ¥æŠ›å‡º
    }
    
    // 5xx æˆ–ç½‘ç»œé”™è¯¯ï¼Œè®°å½•æ—¥å¿—å¹¶è¿”å›é€šç”¨é”™è¯¯
    return ctx.error('[Payment]', err, 'æ”¯ä»˜æœåŠ¡è°ƒç”¨å¤±è´¥');
  }
}
```

### 2. âš ï¸ ä¸ä½¿ç”¨ Service å±‚ï¼ˆæ¶æ„è§„åˆ™ï¼‰

**é‡è¦**: æœ¬é¡¹ç›®ä¸ä½¿ç”¨ Service å±‚ï¼Œæ‰€æœ‰ä¸šåŠ¡é€»è¾‘ç›´æ¥å†™åœ¨ Controller ä¸­ã€‚

#### 2.1 ä¸šåŠ¡é€»è¾‘å†™åœ¨ Controller
```typescript
// âœ… æ­£ç¡®ï¼šä¸šåŠ¡é€»è¾‘ç›´æ¥å†™åœ¨ Controller
export default class ConversationController extends Controller {
  async list() {
    const { ctx } = this;
    await this.validator.index();
    
    const user = ctx.state.user;
    const { page, pageSize } = ctx.query;
    
    // âœ… ä¸šåŠ¡é€»è¾‘ç›´æ¥å†™åœ¨è¿™é‡Œ
    const query = {
      user_id: new Types.ObjectId(user._id),
      del_flag: 0,
      status: 1
    };
    
    // ä½¿ç”¨ CRUD å·¥å…·
    const { paginate } = (ctx as any).utilsCrud;
    const result = await paginate(
      ctx.model.Conversation,
      query,
      { page, pageSize, sort: { created_at: -1 } }
    );
    
    return ctx.success(result);
  }
  
  async create() {
    const { ctx } = this;
    await this.validator.create();
    
    const user = ctx.state.user;
    const { title } = ctx.request.body;
    
    // âœ… ä¸šåŠ¡é€»è¾‘ç›´æ¥å†™åœ¨è¿™é‡Œ
    const { createOne } = (ctx as any).utilsCrud;
    const conversation = await createOne(ctx.model.Conversation, {
      user_id: new Types.ObjectId(user._id),
      title,
      status: 1,
      del_flag: 0,
      created_by: user._id
    });
    
    return ctx.success(conversation, 'åˆ›å»ºæˆåŠŸ');
  }
}
```

**âŒ é”™è¯¯ï¼šä¸è¦åˆ›å»º Service**:
```typescript
// âŒ é”™è¯¯ï¼šä¸è¦åˆ›å»ºæ–°çš„ Service æ–‡ä»¶
// service/ConversationService.ts
export default class ConversationService extends Service {
  async list(userId: string) {
    // âŒ ä¸è¦è¿™æ ·åš
  }
}
```

#### 2.2 é€šç”¨å·¥å…·å‡½æ•°å°è£…è§„åˆ™

**å°è£…æ¡ä»¶**: å½“åŒä¸€æ®µé€»è¾‘**è¢«è°ƒç”¨ â‰¥2 æ¬¡**æ—¶ï¼Œæ‰å°è£…åˆ° `app/utils/` ç›®å½•ã€‚

**âœ… æ­£ç¡®ç¤ºä¾‹**ï¼š
```typescript
// app/utils/conversation-helper.ts
/**
 * æ„å»ºå¯¹è¯æŸ¥è¯¢æ¡ä»¶
 * @param userId ç”¨æˆ·ID
 * @param filters é¢å¤–è¿‡æ»¤æ¡ä»¶
 */
export function buildConversationQuery(userId: string, filters: any = {}) {
  return {
    user_id: new Types.ObjectId(userId),
    del_flag: 0,
    status: 1,
    ...filters
  };
}

/**
 * æ ¼å¼åŒ–å¯¹è¯åˆ—è¡¨
 * @param conversations å¯¹è¯åˆ—è¡¨
 */
export function formatConversationList(conversations: any[]) {
  return conversations.map(conv => ({
    id: conv._id,
    title: conv.title,
    created_at: conv.created_at,
    updated_at: conv.updated_at
  }));
}

// controller/home/ConversationController.ts
import { buildConversationQuery, formatConversationList } from 'utils/conversation-helper';

export default class ConversationController extends Controller {
  async list() {
    const { ctx } = this;
    const user = ctx.state.user;
    
    // âœ… ä½¿ç”¨å°è£…çš„å·¥å…·å‡½æ•°
    const query = buildConversationQuery(user._id, ctx.query);
    
    const { paginate } = (ctx as any).utilsCrud;
    const result = await paginate(ctx.model.Conversation, query, { page: 1, pageSize: 10 });
    
    // âœ… ä½¿ç”¨å°è£…çš„å·¥å…·å‡½æ•°
    result.list = formatConversationList(result.list);
    
    return ctx.success(result);
  }
  
  async detail() {
    const { ctx } = this;
    const user = ctx.state.user;
    
    // âœ… ç¬¬äºŒæ¬¡ä½¿ç”¨ï¼Œè¯æ˜å°è£…æ˜¯å¯¹çš„
    const query = buildConversationQuery(user._id, { _id: ctx.params.id });
    
    // ... å…¶ä»–é€»è¾‘
  }
}
```

**å°è£…åŸåˆ™**:
- âœ… **è°ƒç”¨æ¬¡æ•° â‰¥2**: å°è£…åˆ° utils
- âœ… **çº¯å‡½æ•°**: æ— å‰¯ä½œç”¨ï¼Œä¾¿äºæµ‹è¯•
- âœ… **å•ä¸€èŒè´£**: æ¯ä¸ªå‡½æ•°åªåšä¸€ä»¶äº‹
- âŒ **ä»…è°ƒç”¨1æ¬¡**: ä¸å°è£…ï¼Œç›´æ¥å†™åœ¨ Controller

#### 2.3 å†å² Service ä»£ç å¤„ç†

**ç°çŠ¶**: é¡¹ç›®ä¸­å­˜åœ¨å†å²é—ç•™çš„ Service ä»£ç ï¼ˆ40+ ä¸ªï¼‰

**å¤„ç†è§„åˆ™**:
- âœ… **æ—§ä»£ç **: ä¿æŒç°çŠ¶ï¼Œä¸å¼ºåˆ¶æ”¹é€ 
- âŒ **æ–°ä»£ç **: ä¸å†åˆ›å»ºæ–°çš„ Service
- âœ… **é‡æ„æ—¶**: é€æ­¥å°† Service é€»è¾‘è¿ç§»åˆ° Controller + utils

```typescript
// âœ… å…è®¸ï¼šè°ƒç”¨å†å² Serviceï¼ˆå…¼å®¹æ€§ï¼‰
export default class OldController extends Controller {
  async oldMethod() {
    const { ctx } = this;
    // âœ… å†å² Service å¯ä»¥ç»§ç»­ä½¿ç”¨
    const result = await ctx.service.ai.conversationService.list();
    return ctx.success(result);
  }
}

// âŒ ç¦æ­¢ï¼šåˆ›å»ºæ–°çš„ Service
// service/NewService.ts  â† ä¸è¦åˆ›å»º
```

### 3. æœåŠ¡å™¨ä¹‹é—´è·¯ç”±é€šä¿¡æ— éœ€é‰´æƒ

**å†…éƒ¨æœåŠ¡è·¯ç”±**ï¼ˆ`/internal/*`ï¼‰æ— éœ€é‰´æƒï¼š
```typescript
// routes/internal/index.ts
router.group({
  prefix: '/internal',
  middlewares: [],
}, (group) => {
  // å†…éƒ¨æœåŠ¡æ¥å£æ— éœ€ userAuth
  group.post('/conversation/sync', ctrl.sync);
  group.get('/stats', ctrl.stats);
});
```

### 4. æ•°æ®åº“æ“ä½œè§„èŒƒ

#### 4.1 æŸ¥è¯¢æ•°æ®åº“ç»“æ„ï¼ˆå¼ºåˆ¶ï¼‰
```typescript
// âœ… ä¿®å¤ä»£ç /å†™éœ€æ±‚å‰å¿…é¡»å…ˆæŸ¥è¯¢å®é™…ç»“æ„
// 1. ä½¿ç”¨ MCP è¿æ¥æ•°æ®åº“
// 2. æŸ¥è¯¢ collection schema
// 3. åŸºäºçœŸå®å­—æ®µç¼–å†™ä»£ç 

// ç¤ºä¾‹ï¼šæŸ¥è¯¢ conversations è¡¨ç»“æ„
db.conversations.findOne()
// è·å–å­—æ®µï¼š_id, user_id, title, status, created_at, updated_at, del_flag
```

#### 3.2 æ‰€æœ‰å†™æ“ä½œå¿…é¡»ç¡®è®¤ï¼ˆå¼ºåˆ¶ï¼‰
```typescript
// âš ï¸ å†™å…¥æ“ä½œå‰å¿…é¡»ï¼š
// 1. å±•ç¤ºæ“ä½œå½±å“èŒƒå›´
// 2. æ˜¾ç¤ºå°†è¦ä¿®æ”¹çš„æ•°æ®
// 3. ç­‰å¾…ç”¨æˆ·æ˜ç¡®ç¡®è®¤

// ç¤ºä¾‹ç¡®è®¤æµç¨‹ï¼š
console.log('å³å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š');
console.log('- æ“ä½œç±»å‹ï¼šæ›´æ–°');
console.log('- å½±å“æ–‡æ¡£ï¼š', { _id: xxx, title: 'xxx' });
console.log('- æ›´æ–°å­—æ®µï¼š', { title: 'æ–°æ ‡é¢˜' });
console.log('è¯·ç¡®è®¤æ˜¯å¦ç»§ç»­ï¼Ÿ(y/n)');
// ç­‰å¾…ç”¨æˆ·è¾“å…¥ 'y' åæ‰§è¡Œ
```

#### 3.3 Model ä½¿ç”¨è§„èŒƒ
```typescript
// âœ… æ­£ç¡®ï¼šé€šè¿‡ ctx.model è®¿é—®
const Conversation = ctx.model.Conversation;
const Message = ctx.model.Message;

// Model å‘½åçº¦å®šï¼š
// - æ–‡ä»¶åï¼šsnake_case.tsï¼ˆconversation.tsï¼‰
// - Model åï¼šPascalCaseï¼ˆConversationï¼‰
// - Collection åï¼šå¤æ•° snake_caseï¼ˆconversationsï¼‰
```

### 5. ğŸŒ å›½é™…åŒ–å“åº”è§„èŒƒï¼ˆå¿…é¡»éµå®ˆï¼‰

**æ‰€æœ‰ç»™å‰ç«¯çš„æ¥å£å“åº”å¿…é¡»æ”¯æŒä¸‰ç§è¯­è¨€ï¼š`en`ï¼ˆè‹±æ–‡ï¼‰ã€`zh`ï¼ˆç®€ä½“ä¸­æ–‡ï¼‰ã€`hk`ï¼ˆç¹ä½“ä¸­æ–‡ï¼‰ã€‚**

#### 5.1 å“åº”æ¶ˆæ¯å›½é™…åŒ–ï¼ˆå¼ºåˆ¶ä½¿ç”¨å¸¸é‡ï¼‰

**ğŸ”´ é‡è¦è§„åˆ™ï¼šå¿…é¡»å…ˆå®šä¹‰å¸¸é‡ï¼Œç¦æ­¢åœ¨å“åº”æ—¶ç›´æ¥å†™å­—é¢é‡å¯¹è±¡ã€‚**

**âœ… æ­£ç¡®ï¼šå…ˆå®šä¹‰å¸¸é‡ï¼Œå†ä½¿ç”¨**

```typescript
// app/utils/i18n-messages.ts
/**
 * å›½é™…åŒ–æ¶ˆæ¯å¸¸é‡å®šä¹‰
 * æ‰€æœ‰å“åº”æ¶ˆæ¯å¿…é¡»åœ¨æ­¤æ–‡ä»¶ä¸­é¢„å…ˆå®šä¹‰
 */

// æ¶ˆæ¯ç±»å‹å®šä¹‰
export interface I18nMessage {
  en: string;
  zh: string;
  hk: string;
}

// å¯¹è¯æ¨¡å—æ¶ˆæ¯
export const ConversationMessages = {
  // æˆåŠŸæ¶ˆæ¯
  CREATED: {
    en: 'Conversation created successfully',
    zh: 'åˆ›å»ºå¯¹è¯æˆåŠŸ',
    hk: 'å‰µå»ºå°è©±æˆåŠŸ'
  } as I18nMessage,
  
  UPDATED: {
    en: 'Conversation updated successfully',
    zh: 'æ›´æ–°å¯¹è¯æˆåŠŸ',
    hk: 'æ›´æ–°å°è©±æˆåŠŸ'
  } as I18nMessage,
  
  DELETED: {
    en: 'Conversation deleted successfully',
    zh: 'åˆ é™¤å¯¹è¯æˆåŠŸ',
    hk: 'åˆªé™¤å°è©±æˆåŠŸ'
  } as I18nMessage,
  
  // é”™è¯¯æ¶ˆæ¯
  NOT_FOUND: {
    en: 'Conversation not found',
    zh: 'å¯¹è¯ä¸å­˜åœ¨',
    hk: 'å°è©±ä¸å­˜åœ¨'
  } as I18nMessage,
  
  ALREADY_EXISTS: {
    en: 'Conversation with the same name already exists',
    zh: 'å·²å­˜åœ¨åŒåå¯¹è¯',
    hk: 'å·²å­˜åœ¨åŒåå°è©±'
  } as I18nMessage,
  
  PERMISSION_DENIED: {
    en: 'No permission to access this conversation',
    zh: 'æ— æƒè®¿é—®æ­¤å¯¹è¯',
    hk: 'ç„¡æ¬Šè¨ªå•æ­¤å°è©±'
  } as I18nMessage
};

// é€šç”¨æ¶ˆæ¯
export const CommonMessages = {
  // æˆåŠŸæ¶ˆæ¯
  SUCCESS: {
    en: 'Operation successful',
    zh: 'æ“ä½œæˆåŠŸ',
    hk: 'æ“ä½œæˆåŠŸ'
  } as I18nMessage,
  
  // å‚æ•°é”™è¯¯
  INVALID_PARAMETER: {
    en: 'Invalid parameter',
    zh: 'å‚æ•°é”™è¯¯',
    hk: 'åƒæ•¸éŒ¯èª¤'
  } as I18nMessage,
  
  REQUIRED_FIELD_MISSING: {
    en: 'Required field missing',
    zh: 'ç¼ºå°‘å¿…å¡«å­—æ®µ',
    hk: 'ç¼ºå°‘å¿…å¡«å­—æ®µ'
  } as I18nMessage,
  
  // ç³»ç»Ÿé”™è¯¯
  INTERNAL_ERROR: {
    en: 'Internal server error',
    zh: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
    hk: 'ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤'
  } as I18nMessage,
  
  SERVICE_UNAVAILABLE: {
    en: 'Service temporarily unavailable',
    zh: 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨',
    hk: 'æœå‹™æš«æ™‚ä¸å¯ç”¨'
  } as I18nMessage
};

// controller/home/ConversationController.ts
import { ConversationMessages, CommonMessages } from 'utils/i18n-messages';

export default class ConversationController extends Controller {
  async create() {
    const { ctx } = this;
    await this.validator.create();
    
    const user = ctx.state.user;
    const { title } = ctx.request.body;
    
    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨åŒåå¯¹è¯
    const { findOne } = (ctx as any).utilsCrud;
    const existing = await findOne(ctx.model.Conversation, {
      user_id: new Types.ObjectId(user._id),
      title,
      del_flag: 0
    });
    
    if (existing) {
      // âœ… æ­£ç¡®ï¼šä½¿ç”¨é¢„å®šä¹‰å¸¸é‡
      throw ctx.fail(ConversationMessages.ALREADY_EXISTS, 400);
    }
    
    const { createOne } = (ctx as any).utilsCrud;
    const conversation = await createOne(ctx.model.Conversation, {
      user_id: new Types.ObjectId(user._id),
      title,
      status: 1,
      del_flag: 0,
      created_by: user._id
    });
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨é¢„å®šä¹‰å¸¸é‡
    return ctx.success(conversation, ConversationMessages.CREATED);
  }
  
  async delete() {
    const { ctx } = this;
    const { id } = ctx.params;
    
    const { deleteOne } = (ctx as any).utilsCrud;
    const result = await deleteOne(ctx.model.Conversation, { _id: id });
    
    if (!result) {
      // âœ… æ­£ç¡®ï¼šä½¿ç”¨é¢„å®šä¹‰å¸¸é‡
      throw ctx.fail(ConversationMessages.NOT_FOUND, 404);
    }
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨é¢„å®šä¹‰å¸¸é‡
    return ctx.success(null, ConversationMessages.DELETED);
  }
}
```

**âŒ é”™è¯¯ï¼šç›´æ¥åœ¨å“åº”ä¸­å†™å­—é¢é‡å¯¹è±¡**

```typescript
// âŒ é”™è¯¯ï¼šç›´æ¥å†™å­—é¢é‡å¯¹è±¡ï¼ˆç¦æ­¢ï¼‰
throw ctx.fail({
  en: 'Conversation with the same name already exists',
  zh: 'å·²å­˜åœ¨åŒåå¯¹è¯',
  hk: 'å·²å­˜åœ¨åŒåå°è©±'
}, 400);

return ctx.success(data, {
  en: 'Conversation created successfully',
  zh: 'åˆ›å»ºå¯¹è¯æˆåŠŸ',
  hk: 'å‰µå»ºå°è©±æˆåŠŸ'
});

// âŒ é”™è¯¯ï¼šä»…å•ä¸€è¯­è¨€
throw ctx.fail('å·²å­˜åœ¨åŒåå¯¹è¯', 400);
return ctx.success(data, 'åˆ›å»ºæˆåŠŸ');
```

#### 5.2 å“åº”æ ¼å¼è¯´æ˜

**å“åº”ä¸­çš„ message å¿…é¡»æ˜¯ä»å¸¸é‡æ–‡ä»¶å¯¼å…¥çš„å¯¹è±¡ï¼Œä¸æ˜¯å­—é¢é‡ã€‚**

**æˆåŠŸå“åº”**:
```typescript
import { ConversationMessages } from 'utils/i18n-messages';

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å¸¸é‡
ctx.success(data, ConversationMessages.CREATED)

// å“åº”æ ¼å¼ï¼š
{
  code: 0,
  message: {
    en: 'Conversation created successfully',
    zh: 'åˆ›å»ºå¯¹è¯æˆåŠŸ',
    hk: 'å‰µå»ºå°è©±æˆåŠŸ'
  },
  data: { ... }
}
```

**å¤±è´¥å“åº”**:
```typescript
import { ConversationMessages } from 'utils/i18n-messages';

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å¸¸é‡
throw ctx.fail(ConversationMessages.NOT_FOUND, 404)

// å“åº”æ ¼å¼ï¼š
{
  code: 404,
  message: {
    en: 'Conversation not found',
    zh: 'å¯¹è¯ä¸å­˜åœ¨',
    hk: 'å°è©±ä¸å­˜åœ¨'
  },
  data: null
}
```

**ç³»ç»Ÿé”™è¯¯å“åº”**:
```typescript
import { CommonMessages } from 'utils/i18n-messages';

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å¸¸é‡
ctx.error('[Tag]', err, CommonMessages.INTERNAL_ERROR)

// å“åº”æ ¼å¼ï¼š
{
  code: 500,
  message: {
    en: 'Internal server error',
    zh: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
    hk: 'ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤'
  },
  data: { error: '...' }
}
```

#### 5.3 æ¶ˆæ¯å¸¸é‡ç»„ç»‡ç»“æ„

**æ‰€æœ‰æ¶ˆæ¯å¸¸é‡å¿…é¡»æŒ‰æ¨¡å—ç»„ç»‡åœ¨ `app/utils/i18n-messages.ts` æ–‡ä»¶ä¸­ã€‚**

**æ–‡ä»¶ç»“æ„ç¤ºä¾‹**:

```typescript
// app/utils/i18n-messages.ts
export interface I18nMessage {
  en: string;
  zh: string;
  hk: string;
}

// ============================================================================
// é€šç”¨æ¶ˆæ¯ï¼ˆæ‰€æœ‰æ¨¡å—å…±ç”¨ï¼‰
// ============================================================================
export const CommonMessages = {
  // æ“ä½œæˆåŠŸ
  SUCCESS: {
    en: 'Operation successful',
    zh: 'æ“ä½œæˆåŠŸ',
    hk: 'æ“ä½œæˆåŠŸ'
  } as I18nMessage,
  
  CREATED: {
    en: 'Created successfully',
    zh: 'åˆ›å»ºæˆåŠŸ',
    hk: 'å‰µå»ºæˆåŠŸ'
  } as I18nMessage,
  
  UPDATED: {
    en: 'Updated successfully',
    zh: 'æ›´æ–°æˆåŠŸ',
    hk: 'æ›´æ–°æˆåŠŸ'
  } as I18nMessage,
  
  DELETED: {
    en: 'Deleted successfully',
    zh: 'åˆ é™¤æˆåŠŸ',
    hk: 'åˆªé™¤æˆåŠŸ'
  } as I18nMessage,
  
  // å‚æ•°é”™è¯¯
  INVALID_PARAMETER: {
    en: 'Invalid parameter',
    zh: 'å‚æ•°é”™è¯¯',
    hk: 'åƒæ•¸éŒ¯èª¤'
  } as I18nMessage,
  
  REQUIRED_FIELD_MISSING: {
    en: 'Required field missing',
    zh: 'ç¼ºå°‘å¿…å¡«å­—æ®µ',
    hk: 'ç¼ºå°‘å¿…å¡«å­—æ®µ'
  } as I18nMessage,
  
  INVALID_FORMAT: {
    en: 'Invalid format',
    zh: 'æ ¼å¼é”™è¯¯',
    hk: 'æ ¼å¼éŒ¯èª¤'
  } as I18nMessage,
  
  // ä¸šåŠ¡é”™è¯¯
  NOT_FOUND: {
    en: 'Resource not found',
    zh: 'èµ„æºä¸å­˜åœ¨',
    hk: 'è³‡æºä¸å­˜åœ¨'
  } as I18nMessage,
  
  ALREADY_EXISTS: {
    en: 'Resource already exists',
    zh: 'èµ„æºå·²å­˜åœ¨',
    hk: 'è³‡æºå·²å­˜åœ¨'
  } as I18nMessage,
  
  PERMISSION_DENIED: {
    en: 'Permission denied',
    zh: 'æƒé™ä¸è¶³',
    hk: 'æ¬Šé™ä¸è¶³'
  } as I18nMessage,
  
  // ç³»ç»Ÿé”™è¯¯
  INTERNAL_ERROR: {
    en: 'Internal server error',
    zh: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
    hk: 'ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤'
  } as I18nMessage,
  
  SERVICE_UNAVAILABLE: {
    en: 'Service temporarily unavailable',
    zh: 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨',
    hk: 'æœå‹™æš«æ™‚ä¸å¯ç”¨'
  } as I18nMessage,
  
  REQUEST_TIMEOUT: {
    en: 'Request timeout',
    zh: 'è¯·æ±‚è¶…æ—¶',
    hk: 'è«‹æ±‚è¶…æ™‚'
  } as I18nMessage
};

// ============================================================================
// å¯¹è¯æ¨¡å—æ¶ˆæ¯
// ============================================================================
export const ConversationMessages = {
  CREATED: {
    en: 'Conversation created successfully',
    zh: 'åˆ›å»ºå¯¹è¯æˆåŠŸ',
    hk: 'å‰µå»ºå°è©±æˆåŠŸ'
  } as I18nMessage,
  
  UPDATED: {
    en: 'Conversation updated successfully',
    zh: 'æ›´æ–°å¯¹è¯æˆåŠŸ',
    hk: 'æ›´æ–°å°è©±æˆåŠŸ'
  } as I18nMessage,
  
  DELETED: {
    en: 'Conversation deleted successfully',
    zh: 'åˆ é™¤å¯¹è¯æˆåŠŸ',
    hk: 'åˆªé™¤å°è©±æˆåŠŸ'
  } as I18nMessage,
  
  NOT_FOUND: {
    en: 'Conversation not found',
    zh: 'å¯¹è¯ä¸å­˜åœ¨',
    hk: 'å°è©±ä¸å­˜åœ¨'
  } as I18nMessage,
  
  ALREADY_EXISTS: {
    en: 'Conversation with the same name already exists',
    zh: 'å·²å­˜åœ¨åŒåå¯¹è¯',
    hk: 'å·²å­˜åœ¨åŒåå°è©±'
  } as I18nMessage
};

// ============================================================================
// æ¶ˆæ¯æ¨¡å—æ¶ˆæ¯
// ============================================================================
export const MessageMessages = {
  SENT: {
    en: 'Message sent successfully',
    zh: 'å‘é€æ¶ˆæ¯æˆåŠŸ',
    hk: 'ç™¼é€æ¶ˆæ¯æˆåŠŸ'
  } as I18nMessage,
  
  DELETED: {
    en: 'Message deleted successfully',
    zh: 'åˆ é™¤æ¶ˆæ¯æˆåŠŸ',
    hk: 'åˆªé™¤æ¶ˆæ¯æˆåŠŸ'
  } as I18nMessage,
  
  NOT_FOUND: {
    en: 'Message not found',
    zh: 'æ¶ˆæ¯ä¸å­˜åœ¨',
    hk: 'æ¶ˆæ¯ä¸å­˜åœ¨'
  } as I18nMessage
};

// ============================================================================
// ç”¨æˆ·æ¨¡å—æ¶ˆæ¯
// ============================================================================
export const UserMessages = {
  LOGIN_SUCCESS: {
    en: 'Login successful',
    zh: 'ç™»å½•æˆåŠŸ',
    hk: 'ç™»éŒ„æˆåŠŸ'
  } as I18nMessage,
  
  LOGOUT_SUCCESS: {
    en: 'Logout successful',
    zh: 'é€€å‡ºæˆåŠŸ',
    hk: 'é€€å‡ºæˆåŠŸ'
  } as I18nMessage,
  
  INVALID_CREDENTIALS: {
    en: 'Invalid username or password',
    zh: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯',
    hk: 'ç”¨æˆ¶åæˆ–å¯†ç¢¼éŒ¯èª¤'
  } as I18nMessage,
  
  NOT_FOUND: {
    en: 'User not found',
    zh: 'ç”¨æˆ·ä¸å­˜åœ¨',
    hk: 'ç”¨æˆ¶ä¸å­˜åœ¨'
  } as I18nMessage
};

// æ ¹æ®ä¸šåŠ¡æ¨¡å—ç»§ç»­æ‰©å±•...
```

**ä½¿ç”¨ç¤ºä¾‹**:

```typescript
// controller/home/ConversationController.ts
import { 
  ConversationMessages, 
  CommonMessages 
} from 'utils/i18n-messages';

export default class ConversationController extends Controller {
  async list() {
    const { ctx } = this;
    // ...
    return ctx.success(result, CommonMessages.SUCCESS);
  }
  
  async create() {
    const { ctx } = this;
    // ...
    return ctx.success(conversation, ConversationMessages.CREATED);
  }
  
  async update() {
    const { ctx } = this;
    // ...
    if (!conversation) {
      throw ctx.fail(ConversationMessages.NOT_FOUND, 404);
    }
    return ctx.success(updated, ConversationMessages.UPDATED);
  }
}
```

#### 5.4 æ–°å¢æ¶ˆæ¯å¸¸é‡è§„èŒƒ

**å½“éœ€è¦æ–°å¢å“åº”æ¶ˆæ¯æ—¶ï¼Œå¿…é¡»éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š**

**æ­¥éª¤ 1: åœ¨ i18n-messages.ts ä¸­å®šä¹‰å¸¸é‡**

```typescript
// app/utils/i18n-messages.ts

// æ‰¾åˆ°å¯¹åº”çš„æ¨¡å—ï¼Œæˆ–åˆ›å»ºæ–°çš„æ¨¡å—åˆ†ç»„
export const TripMessages = {
  CREATED: {
    en: 'Trip created successfully',
    zh: 'åˆ›å»ºè¡Œç¨‹æˆåŠŸ',
    hk: 'å‰µå»ºè¡Œç¨‹æˆåŠŸ'
  } as I18nMessage,
  
  INVALID_DATE_RANGE: {
    en: 'Invalid date range',
    zh: 'æ—¥æœŸèŒƒå›´æ— æ•ˆ',
    hk: 'æ—¥æœŸç¯„åœç„¡æ•ˆ'
  } as I18nMessage,
  
  // æ–°å¢çš„æ¶ˆæ¯...
};
```

**æ­¥éª¤ 2: åœ¨ Controller ä¸­å¯¼å…¥å¹¶ä½¿ç”¨**

```typescript
// controller/home/TripController.ts
import { TripMessages, CommonMessages } from 'utils/i18n-messages';

export default class TripController extends Controller {
  async create() {
    const { ctx } = this;
    // ...
    return ctx.success(trip, TripMessages.CREATED);
  }
}
```

**æ­¥éª¤ 3: å¦‚æœæ˜¯é€šç”¨æ¶ˆæ¯ï¼Œä¼˜å…ˆä½¿ç”¨ CommonMessages**

```typescript
// âœ… ä¼˜å…ˆä½¿ç”¨é€šç”¨æ¶ˆæ¯
return ctx.success(data, CommonMessages.CREATED);  // è€Œä¸æ˜¯æ¯ä¸ªæ¨¡å—éƒ½å®šä¹‰ CREATED

// âœ… ä»…åœ¨æ¶ˆæ¯æœ‰ç‰¹æ®Šæ€§æ—¶æ‰å®šä¹‰æ¨¡å—ä¸“å±æ¶ˆæ¯
return ctx.success(trip, TripMessages.DATE_CONFIRMED);  // è¡Œç¨‹ç‰¹æœ‰æ¶ˆæ¯
```

#### 5.5 æ³¨æ„äº‹é¡¹

1. **ğŸ”´ å¿…é¡»å…ˆå®šä¹‰å¸¸é‡**: ç¦æ­¢åœ¨å“åº”æ—¶ç›´æ¥å†™ `{ en, zh, hk }` å­—é¢é‡
2. **ğŸ”´ å¿…é¡»æä¾›ä¸‰ç§è¯­è¨€**: en, zh, hk ä¸‰è€…ç¼ºä¸€ä¸å¯
3. **âœ… ä¿æŒè¯­ä¹‰ä¸€è‡´**: ä¸‰ç§è¯­è¨€è¡¨è¾¾çš„æ„æ€å¿…é¡»ç›¸åŒ
4. **âœ… ç¹ç®€è½¬æ¢**: zh æ˜¯ç®€ä½“ä¸­æ–‡ï¼Œhk æ˜¯ç¹ä½“ä¸­æ–‡
5. **âœ… æ ‡ç‚¹ç¬¦å·**: 
   - ä¸­æ–‡ä½¿ç”¨ä¸­æ–‡æ ‡ç‚¹ï¼ˆã€‚ã€ï¼Œï¼‰
   - è‹±æ–‡ä½¿ç”¨è‹±æ–‡æ ‡ç‚¹ï¼ˆ. ,ï¼‰
6. **âœ… ä¸“ä¸šæœ¯è¯­**: ä¿æŒä¸€è‡´çš„æœ¯è¯­ç¿»è¯‘
7. **âœ… æ¨¡å—åŒ–ç»„ç»‡**: æŒ‰ä¸šåŠ¡æ¨¡å—åˆ†ç»„ï¼ˆCommonMessages/ConversationMessages/TripMessagesï¼‰
8. **âœ… ä¼˜å…ˆå¤ç”¨**: é€šç”¨æ¶ˆæ¯ä¼˜å…ˆä½¿ç”¨ CommonMessagesï¼Œé¿å…é‡å¤å®šä¹‰
9. **âœ… å‘½åè§„èŒƒ**: å¸¸é‡åä½¿ç”¨ UPPER_SNAKE_CASEï¼ˆå¦‚ ALREADY_EXISTS, NOT_FOUNDï¼‰
10. **âœ… ç±»å‹æ ‡æ³¨**: æ‰€æœ‰æ¶ˆæ¯å¯¹è±¡éƒ½åº”æ ‡æ³¨ `as I18nMessage`

---

## ğŸ¯ æ¶æ„å±‚æ¬¡è§„åˆ™

### ä»£ç åˆ†å±‚ï¼ˆâš ï¸ æœ¬é¡¹ç›®ä¸ä½¿ç”¨ Service å±‚ï¼‰

```
Controller (æ§åˆ¶å™¨å±‚) - ä¸šåŠ¡é€»è¾‘ + å‚æ•°æ ¡éªŒ + é‰´æƒ + å“åº”
    â†“ ä½¿ç”¨
Utils (å·¥å…·å±‚) - é€šç”¨å‡½æ•°ï¼ˆè°ƒç”¨ â‰¥2 æ¬¡ï¼‰
    â†“ è°ƒç”¨
Model (æ•°æ®æ¨¡å‹å±‚) - Schema å®šä¹‰
```

### èŒè´£åˆ’åˆ†

- **Controller**: 
  - âœ… å‚æ•°æ ¡éªŒï¼ˆvalidatorï¼‰
  - âœ… é‰´æƒæ£€æŸ¥ï¼ˆmiddlewareï¼‰
  - âœ… **ä¸šåŠ¡é€»è¾‘å®ç°** â­ï¼ˆæœ¬é¡¹ç›®ç‰¹è‰²ï¼‰
  - âœ… æ•°æ®åº“æ“ä½œï¼ˆé€šè¿‡ ctx.utilsCrudï¼‰
  - âœ… ç»Ÿä¸€å“åº”ï¼ˆresponseHelperï¼‰
  
- **Utils** (app/utils/):
  - âœ… é€šç”¨å·¥å…·å‡½æ•°ï¼ˆè°ƒç”¨æ¬¡æ•° â‰¥2ï¼‰
  - âœ… çº¯å‡½æ•°ï¼ˆæ— å‰¯ä½œç”¨ï¼‰
  - âœ… å•ä¸€èŒè´£
  - âŒ ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘

- **Model**:
  - âœ… Schema å®šä¹‰
  - âœ… ç´¢å¼•å®šä¹‰
  - âœ… æ•°æ®éªŒè¯è§„åˆ™
  - âœ… é™æ€æ–¹æ³•/å®ä¾‹æ–¹æ³•ï¼ˆå¯é€‰ï¼‰

### ä»£ç ç¤ºä¾‹

#### âœ… æ­£ç¡®ï¼šä¸šåŠ¡é€»è¾‘å†™åœ¨ Controller

```typescript
// controller/home/ConversationController.ts
export default class ConversationController extends Controller {
  private readonly validator: ConversationValidator;

  constructor(ctx: any) {
    super(ctx);
    this.validator = new ConversationValidator(ctx);
  }

  async list() {
    const { ctx } = this;
    
    // 1. å‚æ•°æ ¡éªŒ
    await this.validator.index();
    
    // 2. è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆé‰´æƒåï¼‰
    const user = ctx.state.user;
    const { page, pageSize, keyword } = ctx.query;
    
    // 3. âœ… ä¸šåŠ¡é€»è¾‘ç›´æ¥å†™åœ¨è¿™é‡Œ
    const query: any = {
      user_id: new Types.ObjectId(user._id),
      del_flag: 0,
      status: 1
    };
    
    // å…³é”®å­—æœç´¢
    if (keyword) {
      query.title = { $regex: keyword, $options: 'i' };
    }
    
    // 4. ä½¿ç”¨ CRUD å·¥å…·æŸ¥è¯¢
    const { paginate } = (ctx as any).utilsCrud;
    const result = await paginate(
      ctx.model.Conversation,
      query,
      { 
        page, 
        pageSize, 
        sort: { created_at: -1 },
        select: '_id title status created_at updated_at'
      }
    );
    
    // 5. ç»Ÿä¸€å“åº”
    return ctx.success(result, 'æŸ¥è¯¢æˆåŠŸ');
  }
  
  async create() {
    const { ctx } = this;
    
    // 1. å‚æ•°æ ¡éªŒ
    await this.validator.create();
    
    // 2. è·å–ç”¨æˆ·ä¿¡æ¯
    const user = ctx.state.user;
    const { title } = ctx.request.body;
    
    // 3. âœ… ä¸šåŠ¡é€»è¾‘ç›´æ¥å†™åœ¨è¿™é‡Œ
    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨åŒåå¯¹è¯
    const { findOne } = (ctx as any).utilsCrud;
    const existing = await findOne(ctx.model.Conversation, {
      user_id: new Types.ObjectId(user._id),
      title,
      del_flag: 0
    });
    
    if (existing) {
      throw ctx.fail('å·²å­˜åœ¨åŒåå¯¹è¯', 400);
    }
    
    // 4. åˆ›å»ºæ–°å¯¹è¯
    const { createOne } = (ctx as any).utilsCrud;
    const conversation = await createOne(ctx.model.Conversation, {
      user_id: new Types.ObjectId(user._id),
      title,
      status: 1,
      del_flag: 0,
      created_by: user._id
    });
    
    // 5. ç»Ÿä¸€å“åº”
    return ctx.success(conversation, 'åˆ›å»ºæˆåŠŸ');
  }
}
```

#### âœ… æ­£ç¡®ï¼šé€šç”¨å‡½æ•°å°è£…åˆ° Utilsï¼ˆè°ƒç”¨ â‰¥2 æ¬¡ï¼‰

```typescript
// app/utils/conversation-helper.ts
import { Types } from 'mongoose';

/**
 * æ„å»ºå¯¹è¯æŸ¥è¯¢æ¡ä»¶
 * @param userId ç”¨æˆ·ID
 * @param filters é¢å¤–è¿‡æ»¤æ¡ä»¶
 */
export function buildConversationQuery(userId: string, filters: any = {}) {
  return {
    user_id: new Types.ObjectId(userId),
    del_flag: 0,
    status: 1,
    ...filters
  };
}

/**
 * æ ¼å¼åŒ–å¯¹è¯åˆ—è¡¨
 * @param conversations å¯¹è¯åˆ—è¡¨
 */
export function formatConversationList(conversations: any[]) {
  return conversations.map(conv => ({
    id: conv._id.toString(),
    title: conv.title,
    created_at: conv.created_at,
    updated_at: conv.updated_at,
    message_count: conv.message_count || 0
  }));
}

// controller/home/ConversationController.ts
import { buildConversationQuery, formatConversationList } from 'utils/conversation-helper';

export default class ConversationController extends Controller {
  async list() {
    const { ctx } = this;
    const user = ctx.state.user;
    
    // âœ… ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼šä½¿ç”¨å°è£…çš„å·¥å…·å‡½æ•°
    const query = buildConversationQuery(user._id, { 
      title: { $regex: ctx.query.keyword, $options: 'i' } 
    });
    
    const { paginate } = (ctx as any).utilsCrud;
    const result = await paginate(ctx.model.Conversation, query, { page: 1, pageSize: 10 });
    
    // âœ… ä½¿ç”¨æ ¼å¼åŒ–å·¥å…·
    result.list = formatConversationList(result.list);
    
    return ctx.success(result);
  }
  
  async detail() {
    const { ctx } = this;
    const user = ctx.state.user;
    
    // âœ… ç¬¬äºŒæ¬¡è°ƒç”¨ï¼šè¯æ˜å°è£…æ˜¯å¿…è¦çš„
    const query = buildConversationQuery(user._id, { _id: ctx.params.id });
    
    const { findOne } = (ctx as any).utilsCrud;
    const conversation = await findOne(ctx.model.Conversation, query);
    
    if (!conversation) {
      throw ctx.fail('å¯¹è¯ä¸å­˜åœ¨', 404);
    }
    
    return ctx.success(conversation);
  }
}
```

#### âŒ é”™è¯¯ï¼šä¸è¦åˆ›å»º Service

```typescript
// âŒ é”™è¯¯ï¼šä¸è¦åˆ›å»ºæ–°çš„ Service æ–‡ä»¶
// service/ConversationService.ts
export default class ConversationService extends Service {
  async list(userId: string) {
    // âŒ ä¸è¦è¿™æ ·åšï¼Œä¸šåŠ¡é€»è¾‘åº”è¯¥åœ¨ Controller
  }
  
  async create(userId: string, title: string) {
    // âŒ ä¸è¦è¿™æ ·åš
  }
}

// âŒ é”™è¯¯ï¼šController ä¸åº”è¯¥è°ƒç”¨ Service
export default class ConversationController extends Controller {
  async list() {
    const { ctx } = this;
    // âŒ é”™è¯¯ï¼šä¸è¦è°ƒç”¨ Service
    const result = await ctx.service.conversationService.list(user._id);
    return ctx.success(result);
  }
}
```

---

## âœ… å¿«é€Ÿæ£€æŸ¥æ¸…å•

### ä»£ç é£æ ¼æ£€æŸ¥
- [ ] ä½¿ç”¨ **PascalCase** å‘½å Controller/Service/Model
- [ ] ä½¿ç”¨ **camelCase** å‘½åæ–¹æ³•å’Œå˜é‡
- [ ] ä½¿ç”¨ **å•å¼•å·**
- [ ] æ‰€æœ‰è¯­å¥ç»“å°¾æœ‰**åˆ†å·**
- [ ] ä½¿ç”¨ **4 ç©ºæ ¼**ç¼©è¿›
- [ ] TypeScript ç±»å‹æ ‡æ³¨å®Œæ•´

### ä¸­é—´ä»¶ä½¿ç”¨æ£€æŸ¥ï¼ˆğŸ”´ å¼ºåˆ¶ï¼‰
- [ ] CRUD æ“ä½œä½¿ç”¨ **ctx.utilsCrud** â­
- [ ] å“åº”ä½¿ç”¨ **ctx.success / ctx.fail / ctx.error** â­
- [ ] æ¥å£é‰´æƒä½¿ç”¨ **userAuth middleware** â­
- [ ] å‚æ•°æ ¡éªŒä½¿ç”¨ **Validator + ctx.validateJoi** â­
- [ ] HTTP è¯·æ±‚ä½¿ç”¨ **ctx.http**ï¼ˆç¦æ­¢ç›´æ¥ç”¨ axios/fetchï¼‰â­
- [ ] å†…éƒ¨æœåŠ¡è·¯ç”±ä½¿ç”¨ **internalAuth** è€Œé userAuth

### æ•°æ®åº“æ“ä½œæ£€æŸ¥ï¼ˆğŸ”´ å¼ºåˆ¶ï¼‰
- [ ] ä¿®å¤ä»£ç å‰**å…ˆæŸ¥è¯¢æ•°æ®åº“å®é™…ç»“æ„** â­
- [ ] ä½¿ç”¨æ­£ç¡®çš„ **Model åç§°å’Œå­—æ®µ**
- [ ] æ‰€æœ‰å†™æ“ä½œï¼ˆinsert/updateï¼‰**ç­‰å¾…ç”¨æˆ·ç¡®è®¤** â­
- [ ] åˆ é™¤æ“ä½œ**æ˜ç¡®è¯´æ˜åŸå› å’Œå½±å“** â­
- [ ] ä½¿ç”¨ **Types.ObjectId** è½¬æ¢ ObjectId å­—æ®µ

### æ¶æ„åˆ†å±‚æ£€æŸ¥ï¼ˆâš ï¸ ä¸ä½¿ç”¨ Service å±‚ï¼‰
- [ ] **ä¸šåŠ¡é€»è¾‘å†™åœ¨ Controller** â­
- [ ] **é€šç”¨å‡½æ•°å°è£…åœ¨ Utils**ï¼ˆè°ƒç”¨ â‰¥2 æ¬¡ï¼‰â­
- [ ] Model ä»…å®šä¹‰ **Schema å’Œç´¢å¼•**
- [ ] **ä¸åˆ›å»ºæ–°çš„ Service æ–‡ä»¶** â­
- [ ] Utils å‡½æ•°ä¸º**çº¯å‡½æ•°**ï¼ˆæ— å‰¯ä½œç”¨ï¼‰
- [ ] å†å² Service ä»£ç ä¿æŒç°çŠ¶ï¼ˆä¸å¼ºåˆ¶æ”¹é€ ï¼‰

### è·¯ç”±é…ç½®æ£€æŸ¥
- [ ] è·¯ç”±ä½¿ç”¨ **egg-router-group** åˆ†ç»„
- [ ] å‰å°è·¯ç”±åœ¨ **/home** å‰ç¼€ä¸‹
- [ ] ç®¡ç†è·¯ç”±åœ¨ **/admin** å‰ç¼€ä¸‹
- [ ] å†…éƒ¨è·¯ç”±åœ¨ **/internal** å‰ç¼€ä¸‹
- [ ] æ¯ä¸ªè·¯ç”±é…ç½®æ­£ç¡®çš„**é‰´æƒä¸­é—´ä»¶**

### TypeScript ç±»å‹æ£€æŸ¥
- [ ] ä½¿ç”¨ **interface** å®šä¹‰å¤æ‚ç±»å‹
- [ ] ä½¿ç”¨ **enum** å®šä¹‰æšä¸¾
- [ ] Controller/Service ç»§æ‰¿æ­£ç¡®çš„åŸºç±»
- [ ] é¿å…ä½¿ç”¨ **as any**ï¼ˆé™¤éå¿…è¦ï¼‰
- [ ] é…ç½®æ­£ç¡®çš„**è·¯å¾„åˆ«å**

### é”™è¯¯å¤„ç†æ£€æŸ¥
- [ ] ä½¿ç”¨ **try-catch** åŒ…è£¹å¼‚æ­¥æ“ä½œ
- [ ] ä¸šåŠ¡é”™è¯¯æŠ›å‡º **ctx.fail(message, 400)**
- [ ] ç³»ç»Ÿé”™è¯¯ä½¿ç”¨ **ctx.error(tag, err, message)**
- [ ] è®°å½•é”™è¯¯æ—¥å¿—ä½¿ç”¨ **ctx.logger.error**
- [ ] ä¸æš´éœ²æ•æ„Ÿé”™è¯¯ä¿¡æ¯ç»™å‰ç«¯

### å›½é™…åŒ–æ£€æŸ¥
- [ ] **æ‰€æœ‰æ¶ˆæ¯åœ¨ i18n-messages.ts ä¸­å®šä¹‰å¸¸é‡** â­ ğŸ”´
- [ ] **ç¦æ­¢åœ¨å“åº”æ—¶ç›´æ¥å†™ { en, zh, hk } å­—é¢é‡** â­ ğŸ”´
- [ ] æ‰€æœ‰å“åº”æ¶ˆæ¯åŒ…å« **en, zh, hk** ä¸‰ç§è¯­è¨€ â­
- [ ] æˆåŠŸæ¶ˆæ¯ä½¿ç”¨ **ctx.success(data, MessageConstant)** â­
- [ ] å¤±è´¥æ¶ˆæ¯ä½¿ç”¨ **ctx.fail(MessageConstant, code)** â­
- [ ] ç³»ç»Ÿé”™è¯¯ä½¿ç”¨ **ctx.error(tag, err, MessageConstant)** â­
- [ ] ä¸‰ç§è¯­è¨€è¯­ä¹‰ä¿æŒä¸€è‡´
- [ ] ç¹ç®€è½¬æ¢æ­£ç¡®ï¼ˆzh=ç®€ä½“ï¼Œhk=ç¹ä½“ï¼‰
- [ ] é€šç”¨æ¶ˆæ¯ä¼˜å…ˆä½¿ç”¨ CommonMessages
- [ ] å¸¸é‡å‘½åä½¿ç”¨ UPPER_SNAKE_CASE

---

**æœ€åæ›´æ–°**: 2025-11-25

