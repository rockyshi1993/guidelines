# v3 文档规范

> **文件**: specs/rules/文档规范.md  
> **版本**: v3.0  
> **日期**: 2025-11-20  
> **说明**: AI 生成文档的规范

---

## 📑 目录导航

> 🔴 = 必须生成 | 🟡 = 建议生成 | 🟢 = 可选生成

- [文档类型](#-文档类型) 🔴 - 4种必须生成的文档
  - [必须生成的文档](#必须生成的文档) 🔴 - README/IMPLEMENTATION/STATUS/CHANGELOG
- [README.md 规范](#-readmemd-规范) 🔴 - 模块说明文档
  - [模块 README 结构](#模块-readme-结构) 🔴 - 功能/安装/使用/示例
- [IMPLEMENTATION.md 规范](#-implementationmd-规范) 🔴 - 实现方案文档，必须同步
  - [同步规则](#同步规则) 🔴 - 架构/流程变化必须更新
- [STATUS.md 规范](#-statusmd-规范) 🔴 - 状态标识文档
  - [项目 STATUS 结构](#项目-status-结构) 🔴 - 整体状态概览
  - [模块 STATUS 结构](#模块-status-结构) 🔴 - 模块详细状态
  - [状态标识符](#状态标识符) 🔴 - ✅🔄⏸️ 和 🟢🟡🔴
- [CHANGELOG.md 规范](#-changelogmd-规范) 🔴 - 变更日志文档
  - [项目 CHANGELOG](#项目-changelog) 🔴 - 整体变更概览
  - [模块 CHANGELOG](#模块-changelog) 🔴 - 详细变更记录
  - [变更类型](#变更类型) 🔴 - Added/Changed/Deprecated/Removed/Fixed/Security
- [API文档规范](#-api文档规范) 🔴 - Swagger自动生成
- [文档更新触发条件](#-文档更新触发条件) 🔴 - 何时必须更新文档
- [Profile 优先](#-profile-优先) 🟡 - 项目可自定义文档结构

---

## 📚 相关规范文件

**文档生成时必须配合使用**:
- 📦 [流程.md](../core/流程.md) 🔴 - STEP 15生成文档
- 📦 [目录结构.md](../core/目录结构.md) 🔴 - docs/目录结构
- 📐 [API规范.md](./API规范.md) 🔴 - Swagger文档生成
- 📄 [报告模板.md](../output/报告模板.md) 🟡 - 文档清单格式

**相关规范**:
- 📐 [代码规范.md](./代码规范.md) 🟡 - JSDoc注释转文档

**Profile优先**:
- 🔴 如果项目Profile要求额外的文档类型，必须生成

---

## 📋 文档类型

### 必须生成的文档

```yaml
模块文档:
  - README.md: 模块说明
  - IMPLEMENTATION.md: 实现方案（持续同步）
  - STATUS.md: 模块状态
  - CHANGELOG.md: 详细变更日志

API文档:
  - endpoints.md: 接口说明
  - openapi.yaml: Swagger文档
  - examples/: 请求响应示例

项目文档:
  - STATUS.md: 项目整体状态
  - CHANGELOG.md: 整体变更概览
```

---

## 📝 README.md 规范

### 模块 README 结构

```markdown
# {模块名}

> 简短描述模块的用途

## 📋 功能概述

- 功能1
- 功能2
- 功能3

## 🚀 快速开始

### 安装

\`\`\`bash
npm install
\`\`\`

### 使用

\`\`\`javascript
import { Module } from './module';

const instance = new Module();
instance.doSomething();
\`\`\`

## 📖 API文档

参见 [API文档](./api/endpoints.md)

## 🔧 配置

\`\`\`javascript
{
  "option1": "value1",
  "option2": "value2"
}
\`\`\`

## 🧪 测试

\`\`\`bash
npm test
\`\`\`

## 📝 示例

参见 [examples/](./examples/)

## 🔗 相关链接

- [实现方案](../../plans/{模块名}/IMPLEMENTATION.md)
- [变更日志](../../plans/{模块名}/CHANGELOG.md)

## 📄 许可证

MIT
```

### 必须包含的部分

```yaml
必须有:
  - 模块名和描述
  - 功能概述
  - 快速开始
  - API文档链接
  - 相关链接

可选:
  - 配置说明
  - 测试说明
  - 示例
  - 常见问题
```

---

## 📋 IMPLEMENTATION.md 规范

### 实现方案结构

```markdown
# 实现方案: {模块名}

> ⚠️ 此文档必须与实际代码保持同步！

## 📊 版本历史

| 版本 | 日期 | 修改原因 | 修改人 |
|-----|------|---------|--------|
| v1.0 | 2025-11-01 | 初始设计 | AI |
| v1.1 | 2025-11-15 | 调整Token策略 | AI |

## 🎯 模块概述

### 职责
- 职责1
- 职责2

### 边界
- 不负责X
- 不负责Y

## 🏗️ 架构设计

### 模块结构

\`\`\`
module/
├── controllers/
├── services/
├── models/
└── utils/
\`\`\`

### 依赖关系

\`\`\`mermaid
graph TD
  A[Controller] --> B[Service]
  B --> C[Model]
  B --> D[ExternalAPI]
\`\`\`

## 🔄 核心流程

### 主要流程1

\`\`\`
1. 接收请求
2. 验证参数
3. 调用服务
4. 返回结果
\`\`\`

### 异常处理

\`\`\`
1. 捕获异常
2. 记录日志
3. 返回错误响应
\`\`\`

## 🔐 安全设计

- 认证方式: JWT
- 授权方式: RBAC
- 数据加密: AES-256

## 📊 性能要求

- 响应时间: < 100ms
- 并发量: > 1000 req/s
- 可用性: 99.9%

## 💾 数据设计

### 数据模型

\`\`\`typescript
interface User {
  id: string;
  email: string;
  name: string;
}
\`\`\`

### 数据库Schema

\`\`\`sql
CREATE TABLE users (
  id VARCHAR(36) PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL
);
\`\`\`

## 🔄 实现变更记录

### v1.1 (2025-11-15)

**变更原因**: Token过期时间太短

**变更内容**:
- 将access_token过期时间从1小时改为24小时
- 新增refresh_token机制

**影响范围**:
- 文件: src/auth/token.js
- API: POST /api/auth/refresh

**测试验证**:
- ✅ 单元测试通过
- ✅ 集成测试通过
```

### 同步规则

```yaml
必须同步更新的情况:
  - 新增/删除/重命名 类/模块/文件
  - 修改模块间依赖关系
  - 改变数据模型结构
  - 修改数据库schema
  - 改变API接口定义
  - 引入新的设计模式
  - 改变模块职责划分
  - 修改业务流程步骤
  - 改变函数调用顺序
  - 新增/删除关键业务逻辑

仅更新CHANGELOG的情况:
  - 优化函数内部算法
  - 修复bug
  - 调整代码格式
  - 更新注释
  - 性能优化（不改变架构）
```

---

## 📋 STATUS.md 规范

### 项目 STATUS 结构

```markdown
# Project Status

> Last Updated: 2025-11-20 14:30:00  
> Auto-generated by AI

## 📊 Overall Status

- Project Phase: Development
- Health: 🟢 Healthy
- Progress: 65%
- Last Activity: 2025-11-20 14:00:00

## 📦 Modules Status

| Module | Status | Health | Progress | Last Update |
|--------|--------|--------|----------|-------------|
| user-auth | ✅ Completed | 🟢 | 100% | 2025-11-20 |
| order | 🔄 In Progress | 🟢 | 65% | 2025-11-20 |
| payment | ⏸️ Pending | 🟡 | 0% | - |

## 🎯 Current Sprint

- Sprint: Sprint 5
- Start: 2025-11-15
- End: 2025-11-29
- Progress: 60%

### Sprint Goals
- [ ] 完成订单模块核心功能
- [ ] 集成支付网关
- [x] 优化用户认证性能

## 📈 Metrics

- Total Modules: 10
- Completed: 4
- In Progress: 3
- Pending: 3
- Code Coverage: 85%
- Technical Debt: Low

## ⚠️ Issues

### 🔴 Critical
- None

### 🟡 Warning
- Order模块性能需要优化

## 🔄 Recent Activity

- 2025-11-20 14:00: 完成订单查询接口
- 2025-11-20 10:00: 修复用户认证bug
- 2025-11-19 16:00: 部署到测试环境
```

### 模块 STATUS 结构

```markdown
# Module Status: {模块名}

> Last Updated: 2025-11-20 14:30:00  
> Auto-generated by AI

## 📊 Module Status

- Status: ✅ Completed / 🔄 In Progress / ⏸️ Pending
- Health: 🟢 Healthy / 🟡 Warning / 🔴 Critical
- Progress: 100%
- Start Date: 2025-11-01
- Completion Date: 2025-11-20

## ✅ Completed

- [x] 用户注册功能
- [x] 用户登录功能
- [x] Token刷新功能
- [x] 密码重置功能

## 🔄 In Progress

- [ ] 第三方登录集成

## ⏸️ Pending

- [ ] 多因素认证

## 📈 Metrics

- Code Coverage: 95%
- API Response Time: Avg 45ms, P95 80ms
- Error Rate: 0.01%
- Uptime: 99.99%

## 🧪 Testing

- Unit Tests: 50 passed, 0 failed
- Integration Tests: 20 passed, 0 failed
- E2E Tests: 10 passed, 0 failed

## 📝 Documentation

- README: ✅ Complete
- API Docs: ✅ Complete
- Implementation: ✅ Up to date
- Examples: ✅ Available

## ⚠️ Known Issues

- None

## 🔄 Recent Changes

- 2025-11-20: 优化Token刷新逻辑
- 2025-11-19: 修复密码验证bug
```

### 状态标识

```yaml
状态值:
  ✅ Completed: 已完成
  🔄 In Progress: 进行中
  ⏸️ Pending: 待开始
  ❌ Failed: 失败
  🚫 Blocked: 阻塞

健康状态:
  🟢 Healthy: 健康（无问题）
  🟡 Warning: 警告（有小问题）
  🔴 Critical: 严重（有重大问题）

进度:
  0-25%: 刚开始
  26-50%: 进行中
  51-75%: 大部分完成
  76-99%: 接近完成
  100%: 已完成
```

---

## 📋 CHANGELOG.md 规范

### 根目录 CHANGELOG 结构

```markdown
# Changelog

> 项目整体变更概览，不包含详细操作  
> 详细变更请查看各模块的 CHANGELOG.md

## [Unreleased]

### 2025-11-20
- **order**: 完成订单查询接口
- **user-auth**: 优化Token刷新逻辑
- **payment**: 开始集成支付网关

### 2025-11-19
- **user-auth**: 修复密码验证bug
- **order**: 开始开发订单模块

## [1.2.0] - 2025-11-15

### Added
- 新增订单模块
- 新增支付模块

### Changed
- 优化用户认证性能

### Fixed
- 修复内存泄漏问题

## [1.1.0] - 2025-11-01

### Added
- 新增用户认证模块

### Changed
- 更新API文档

## [1.0.0] - 2025-10-01

### Added
- 初始版本发布
```

### 模块 CHANGELOG 结构

```markdown
# Changelog: {模块名}

> 详细记录模块内部所有变更

## [Unreleased]

### 2025-11-20

#### Added
- 新增Token刷新接口
  - 端点: POST /api/auth/refresh
  - 支持refresh_token机制
  
#### Changed
- [2025-11-20 14:00] 优化Token刷新逻辑
  - 文件: src/auth/token.js
  - 修改: 将过期时间从1小时改为24小时
  - 原因: 用户反馈过期太快
  - 影响: 所有使用Token的接口

#### Fixed
- [2025-11-20 10:00] 修复密码验证bug
  - 问题: 特殊字符密码无法验证
  - 文件: src/auth/password.js
  - 修复: 更新正则表达式
  - 测试: 新增10个测试用例

## [1.1.0] - 2025-11-15

### Added
- 实现用户登录功能
  - 端点: POST /api/auth/login
  - 支持邮箱和用户名登录
  - 返回access_token和refresh_token

### Changed
- 优化密码加密性能
  - 从bcrypt切换到argon2
  - 性能提升50%

### Fixed
- 修复邮箱验证正则表达式错误

## [1.0.0] - 2025-11-01

### Added
- 实现用户注册功能
  - 端点: POST /api/auth/register
  - 支持邮箱注册
  - 密码强度验证
```

### 格式规范

```yaml
版本号:
  格式: [主版本.次版本.修订版本]
  示例: [1.2.3]

日期:
  格式: YYYY-MM-DD
  示例: 2025-11-20

分类:
  Added: 新增功能
  Changed: 功能变更
  Deprecated: 即将废弃
  Removed: 已删除
  Fixed: Bug修复
  Security: 安全修复

详细程度:
  根目录CHANGELOG: 仅概览
    - 模块名 + 简短描述
    - 不超过1行
  
  模块CHANGELOG: 详细记录
    - 时间戳
    - 具体文件
    - 修改原因
    - 影响范围
    - 测试验证
```

---

## 📋 API 文档规范

### endpoints.md 结构

```markdown
# API 文档: {模块名}

## 基本信息

- Base URL: `https://api.example.com/v1`
- 认证方式: Bearer Token
- 响应格式: JSON

## 接口列表

### 用户注册

**端点**: `POST /api/auth/register`

**描述**: 创建新用户账号

**请求头**:
\`\`\`
Content-Type: application/json
\`\`\`

**请求体**:
\`\`\`json
{
  "email": "user@example.com",
  "password": "Password123!",
  "name": "Test User"
}
\`\`\`

**响应**: `201 Created`
\`\`\`json
{
  "success": true,
  "data": {
    "id": "123",
    "email": "user@example.com",
    "name": "Test User",
    "createdAt": "2025-11-20T10:00:00Z"
  }
}
\`\`\`

**错误响应**: `400 Bad Request`
\`\`\`json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "输入验证失败",
    "details": {
      "email": ["邮箱格式不正确"]
    }
  }
}
\`\`\`

**示例**:
\`\`\`bash
curl -X POST https://api.example.com/v1/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "Password123!",
    "name": "Test User"
  }'
\`\`\`

---

### 用户登录

**端点**: `POST /api/auth/login`

**描述**: 用户登录获取Token

...
```

### 必须包含的信息

```yaml
每个接口必须包含:
  - 端点URL
  - HTTP方法
  - 描述
  - 请求头
  - 请求参数（path/query/body）
  - 成功响应（含示例）
  - 错误响应（含示例）
  - curl命令示例

可选:
  - 速率限制
  - 权限要求
  - 注意事项
```

---

## 🔄 文档同步规则

### 自动更新触发

```yaml
STEP 15: 生成和更新文档

触发条件:
  - 代码开发完成
  - 测试通过
  - 用户确认测试结果

自动更新的文档:
  1. README.md（如果是新模块）
  2. endpoints.md（如果API变更）
  3. openapi.yaml（如果API变更）
  4. IMPLEMENTATION.md（如果架构/流程变更）
  5. STATUS.md（总是更新）
  6. CHANGELOG.md（总是更新）
```

### 同步验证

```yaml
STEP 17: 代码质量最终验证

文档同步验证:
  检查项:
    - IMPLEMENTATION.md与代码是否一致
    - API文档是否反映实际接口
    - Swagger是否与代码匹配
    - 示例代码是否可运行
  
  IF: 发现不一致
  THEN:
    - 标记需要更新的文档
    - 返回 STEP 15 更新文档
```

---

## 📝 文档格式规范

### Markdown 规范

```yaml
标题:
  - 使用 # 表示标题
  - 层级不超过4级
  - 标题前后空行

代码块:
  - 使用 ``` 包裹
  - 指定语言（javascript/bash/json等）
  - 代码格式化

链接:
  - 使用相对路径
  - 检查链接有效性

表格:
  - 使用 | 分隔
  - 对齐格式

列表:
  - 有序列表用数字
  - 无序列表用 - 或 *
```

### 示例代码规范

```yaml
必须:
  - 代码可运行
  - 包含完整上下文
  - 使用真实但脱敏的数据
  - 包含注释说明

禁止:
  - 不完整的代码片段
  - 错误的代码
  - 真实的敏感数据
  - 过于复杂的示例
```

---

## 📊 文档质量检查

### 检查清单

```yaml
README.md:
  ✅ 包含模块描述
  ✅ 包含快速开始
  ✅ 包含API文档链接
  ✅ 示例代码可运行
  ✅ 链接都有效

IMPLEMENTATION.md:
  ✅ 版本历史完整
  ✅ 架构图清晰
  ✅ 流程描述准确
  ✅ 与代码一致

STATUS.md:
  ✅ 状态准确
  ✅ 进度真实
  ✅ 指标有效
  ✅ 自动更新

CHANGELOG.md:
  ✅ 时间顺序正确
  ✅ 分类合理
  ✅ 描述清晰
  ✅ 包含影响范围

API文档:
  ✅ 所有接口都有文档
  ✅ 示例完整
  ✅ 错误码齐全
  ✅ Swagger匹配
```

---

## 🔧 文档生成工具

### 自动生成

```yaml
从代码生成:
  - JSDoc → API文档
  - TypeScript类型 → 数据模型
  - 路由定义 → 接口列表
  - 测试用例 → 示例代码

从注释生成:
  - 函数注释 → 函数说明
  - 类注释 → 类说明
  - 参数注释 → 参数说明

工具:
  - JSDoc
  - TypeDoc
  - Swagger/OpenAPI
  - Docusaurus
```

---

**文件创建**: 2025-11-20  
**最后更新**: 2025-11-20  
**状态**: ✅ 完整

