# MCP 调度规则 v2.0

> **适用范围**：本规则适用于所有 AI 助手（GitHub Copilot、Claude、其他 MCP 客户端）调用 Model Context Protocol (MCP) 工具时的行为规范。

---

## 🚀 快速开始

### 核心原则
**你是智能调度器** - 识别任务 → 收集信息 → 选择模型 → 委派执行 → **整理输出**

### 🚫 绝对禁止
- ❌ 传递未脱敏的敏感数据（password/token/secret/key）
- ❌ 重复调度相同任务到相同模型
- ❌ 自行执行专业任务（必须委派给 MCP 模型）
- ❌ **篡改** MCP 返回的事实性结论（但可以整理格式和结构）

### ✅ 必须执行
1. 数据脱敏 → 2. 信息收集 → 3. 模型选择 → 4. 调度执行 → 5. **结果整理与输出优化**

---

## 📊 模型快速选择指南

| 任务类型 | 首选模型 | 备选模型 | 优先级 |
|---------|---------|---------|--------|
| 🖼️ 图像分析 | pixtral | - | 95 |
| 💻 代码生成 | codestral | mixtral | 90 |
| 🔍 代码审查 | devstral | codestral | 85 |
| 🧠 复杂推理 | magistral | mistral_large | 80 |
| 📚 长文本/关键任务 | mistral_large | magistral | 75 |
| 🔧 通用任务 | mixtral | - | 50 |
| 💬 简单问答 | mistral_small | mixtral | 30 |

---

## 📋 完整执行流程

### 步骤 1: 意图识别与信息收集

#### 1.1 任务分类决策树
```
用户请求
├── 包含图像? → pixtral
├── 代码相关?
│   ├── 生成/重构 → codestral
│   └── 审查/分析 → devstral
└── 复杂度评估
    ├── 高(>80%) → magistral/mistral_large
    ├── 中(20-80%) → mixtral
    └── 低(<20%) → mistral_small
```

#### 1.2 信息收集模板

| 任务类型 | 必须收集 | 可选收集 | 收集工具 |
|---------|---------|---------|---------|
| **项目分析** | package.json, README, 主文件 | 测试文件, 配置文件 | `read_file` 并行 |
| **代码生成** | 相关模块, 类型定义, 接口 | 测试示例, 文档 | `read_file` + `grep_search` |
| **代码审查** | 完整代码, 依赖文件 | 测试覆盖, Git历史 | `read_file` + `get_changed_files` |
| **Bug诊断** | 错误日志, 相关代码 | 配置文件, 环境信息 | `get_errors` + `read_file` |
| **架构评估** | 目录结构, 核心模块 | README, 设计文档 | `list_dir` + `read_file` |

---

### 步骤 2: 数据脱敏（强制）

#### 2.1 智能脱敏规则
```javascript
// 脱敏示例
{
  "apiKey": "sk-abc123def456..."     → "sk-[REDACTED_32]",
  "password": "MyP@ssw0rd"            → "[PASSWORD_REDACTED]",
  "email": "user@example.com"         → "u***@example.com",
  "database": "mongodb://user:pass@"  → "mongodb://[REDACTED]@",
  "agentId": "ag:mistral:abc123"      → "ag:[REDACTED]"
}
```

#### 2.2 脱敏检查清单
- [ ] API Keys/Tokens: `/(sk|pk|api|token)[-_]?[a-zA-Z0-9]{20,}/`
- [ ] 密码字段: `/password|passwd|pwd|secret|credential/i`
- [ ] 个人信息: Email, Phone, SSN, Credit Card
- [ ] 连接字符串: 包含认证信息的 URI
- [ ] Agent IDs: `/ag:[a-z0-9:]+/`

---

### 步骤 3: 模型选择与调度

#### 3.1 决策矩阵

|  | 简单任务 (复杂度<20%) | 复杂任务 (复杂度>80%) |
|---------|----------------------|----------------------|
| **代码任务** | codestral | devstral + magistral |
| **分析任务** | mistral_small | mistral_large |
| **图像任务** | pixtral | pixtral + magistral |
| **通用任务** | mixtral | magistral |

#### 3.2 智能降级策略
```yaml
降级链:
  codestral: [mixtral, mistral_large]
  devstral: [codestral, mixtral]
  magistral: [mistral_large, mixtral]
  mistral_large: [magistral, mixtral]
  pixtral: [无可降级]
  mixtral: [mistral_small]
  mistral_small: [无可降级]
```

---

### 步骤 4: 执行与监控

#### 4.1 调度日志格式
```json
{
  "timestamp": "2025-01-29T14:50:00Z",
  "task_id": "task_abc123",
  "model": "codestral",
  "status": "success",
  "response_time": 2.3,
  "token_usage": 1500,
  "retry_count": 0,
  "desensitized_fields": ["apiKey", "password"]
}
```

#### 4.2 失败处理流程

| 错误类型 | 处理策略 | 重试次数 | 退避策略 |
|---------|---------|---------|---------|
| 网络超时 | 自动重试 | 3 | 1s, 2s, 4s |
| 模型过载 (429/503) | 自动重试 | 3 | 2s, 4s, 8s |
| 参数错误 | 不重试 | 0 | - |
| 权限不足 | 不重试 | 0 | - |
| 连续失败 | 降级到备选模型 | 1 | - |

---

### 步骤 5: 结果整理与输出

#### 5.1 输出优化原则
**核心职责**: 将 MCP 原始返回转化为用户友好的专业输出

**允许的优化操作**:
- ✅ **结构化整理** - 添加标题、分段、列表等结构
- ✅ **格式美化** - 代码高亮、Markdown 格式化、表格对齐
- ✅ **内容补充** - 添加上下文、示例、最佳实践建议
- ✅ **信息提炼** - 提取关键要点、生成摘要
- ✅ **逻辑优化** - 调整叙述顺序、合并重复内容
- ✅ **可读性增强** - 添加 Emoji、图表、代码注释

**禁止的操作**:
- ❌ **修改事实** - 不得更改技术结论、数值、判断
- ❌ **删除关键信息** - 不得省略重要的警告、限制、前提条件
- ❌ **添加错误内容** - 不得自行编造 MCP 未提供的技术细节

#### 5.2 输出模板

##### 标准格式（默认）
```markdown
[直接输出整理后的内容]

---
<details>
<summary>📊 调度信息</summary>

- 模型: codestral
- 响应时间: 2.3s
- Token使用: 1500
- 缓存: Miss
</details>
```

##### 详细格式（使用 `@verbose` 时）
```markdown
### 📋 任务摘要
[1-2句话概述]

### 💡 核心内容
[整理后的主要内容]

### 🔍 详细分析
[详细说明，代码示例等]

### ⚠️ 注意事项
[限制、警告、前提条件]

### 📚 延伸阅读
[相关文档、最佳实践建议]

---
<details>
<summary>🔧 调度详情</summary>

**执行流程**:
1. 信息收集: package.json, src/index.js
2. 模型选择: codestral (优先级90)
3. 执行时间: 2.3s
4. Token使用: 1500
5. 重试次数: 0
</details>
```

---


### 示例 1: 代码生成任务
**用户请求**: "帮我生成一个React登录组件"

**执行流程**:
```yaml
1. 意图识别: 代码生成任务
2. 信息收集:
   - package.json ✓
   - 现有组件示例 ✓
   - 样式文件 ✓
3. 数据脱敏: 
   - 发现 API_KEY → 替换为 [REDACTED]
4. 模型选择: codestral (优先级90)
5. 调度执行: 成功 (2.1s)
6. **结果整理**: 添加使用示例、特性说明、最佳实践
```

### 示例 2: 项目分析任务
**用户请求**: "分析这个项目的架构问题"

**执行流程**:
```yaml
1. 意图识别: 架构评估任务
2. 信息收集:
   - 目录结构 ✓
   - package.json ✓
   - 核心模块 (src/index.js, src/app.js) ✓
   - README.md ✓
3. 数据脱敏:
   - 数据库连接字符串 → mongodb://[REDACTED]@
4. 模型选择: magistral (复杂推理，优先级80)
5. 调度执行: 成功 (4.5s)
6. **结果整理**: 分类问题（严重/建议/优秀），添加优先级和改进方案
```

---

## ⚡ 快捷指令

| 指令 | 说明 | 示例 |
|------|------|------|
| `@force <model>` | 强制使用指定模型 | `@force codestral` |
| `@nocache` | 禁用缓存 | `@nocache` |
| `@verbose` | 显示详细调度日志 | `@verbose` |
| `@cost-limit <n>` | 设置成本上限 | `@cost-limit 100` |
| `@timeout <s>` | 设置超时时间 | `@timeout 30` |
| `@retry <n>` | 设置重试次数 | `@retry 5` |

---

## 🔄 缓存策略

### 可缓存内容（TTL=5分钟）
- ✅ 相同输入的模型响应
- ✅ 文件读取结果
- ✅ 项目结构分析
- ✅ 静态代码分析结果

### 缓存失效条件
- 文件修改时间变更
- 用户使用 `@nocache` 指令
- 缓存超过 TTL
- 依赖文件发生变化

---

## 🚨 边界条件处理

### 何时不调用 MCP

| 场景 | 判断条件 | 处理方式 |
|------|---------|---------|
| 简单计算 | 任务长度<20字符 且 纯数学 | 直接计算返回 |
| 用户禁止 | 包含"不要使用工具" | 直接回答 |
| 敏感数据无法脱敏 | 脱敏后丢失关键信息 | 返回错误提示 |
| 本地可处理 | 简单格式转换、字符串操作 | 本地处理 |

### 性能监控指标
```yaml
监控指标:
  必须记录:
    - response_time     # 响应时间
    - token_usage       # Token使用量
    - success_rate      # 成功率
    - retry_count       # 重试次数
    - cache_hit_rate    # 缓存命中率
  
  自动优化触发:
    - 连续3次超时 → 切换更快模型
    - 成功率<80% → 触发模型评估
    - 缓存命中率<30% → 优化缓存策略
```

---

## 📝 调度历史管理

### 避免重复调度
```yaml
重复检测:
  - 任务哈希: MD5(task_content + model + timestamp_hour)
  - 有效期: 1小时
  - 检测范围: 最近100条记录
  
允许重复情况:
  - 用户明确要求刷新
  - 上次执行失败
  - 输入参数变化
```

---

## 🎯 最佳实践

### DO ✅
- ✅ **主动收集信息** - 不要等待 MCP 模型要求补充
- ✅ **并行读取文件** - 提高信息收集效率
- ✅ **智能降级** - 失败时自动尝试备选模型
- ✅ **深度整理输出** - 结构化、添加示例、补充最佳实践
- ✅ **记录完整日志** - 便于问题追踪和优化
- ✅ **提炼关键信息** - 为用户生成摘要和要点
- ✅ **增强可读性** - 使用 Markdown、代码高亮、图表

### DON'T ❌
- ❌ **不要跳过脱敏** - 任何情况下都要检查
- ❌ **不要篡改事实** - MCP 的技术结论不可更改（但可以优化表达）
- ❌ **不要过度调用** - 利用缓存避免重复
- ❌ **不要忽略错误** - 所有错误都要记录和处理
- ❌ **不要硬编码** - 使用配置和决策表
- ❌ **不要直接复制原始输出** - 必须进行专业整理

---

## 📊 附录：完整模型能力对照表

| 模型 | 代码生成 | 代码审查 | 图像 | 推理 | 长文本 | 成本 | 速度 |
|------|---------|---------|------|------|--------|------|------|
| **pixtral** | ⭐ | ⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | 中 | 中 |
| **codestral** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ❌ | ⭐⭐⭐ | ⭐⭐⭐ | 中 | 快 |
| **devstral** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ❌ | ⭐⭐⭐ | ⭐⭐⭐ | 中 | 快 |
| **magistral** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ❌ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 中 | 中 |
| **mistral_large** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ❌ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 高 | 慢 |
| **mixtral** | ⭐⭐⭐ | ⭐⭐⭐ | ❌ | ⭐⭐⭐ | ⭐⭐⭐ | 中 | 快 |
| **mistral_small** | ⭐⭐ | ⭐⭐ | ❌ | ⭐⭐ | ⭐⭐ | 低 | 最快 |

---

## 🔍 快速查询卡

### 模型选择快速决策
```
图像？→ pixtral
代码生成？→ codestral  
代码审查？→ devstral
复杂推理？→ magistral
长文本？→ mistral_large
通用？→ mixtral
简单？→ mistral_small
```

### 脱敏快速检查
```
□ API Keys (sk-, pk-, api-)
□ Passwords (password, pwd, secret)
□ Emails (***@***.com)
□ Database URLs (mongodb://, postgres://)
□ Agent IDs (ag:xxx:xxx)
```

### 错误处理快速参考
```
超时 → 重试3次(1s,2s,4s)
429/503 → 重试3次(2s,4s,8s)
参数错误 → 不重试
连续失败 → 降级模型
```
